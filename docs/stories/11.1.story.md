# Story 11.1: PWA Shell & Navigation

## Status
Approved

## Story
**As a** club official,
**I want** a mobile-first progressive web app,
**So that** I can access FirstBell on any device.

## Acceptance Criteria
1. PWA is installable on mobile devices (manifest.json, service worker)
2. Bottom navigation displays three tabs: Inbox, Club, Browse
3. Offline-read tolerant (basic service worker caching for app shell)
4. Responsive design: mobile-first with desktop adaptation
5. AI Bar placeholder is visible at top of all screens (non-functional in this story)
6. Firebase Authentication integration allows login/logout
7. Authenticated users see main app shell; unauthenticated users see login screen

## Tasks / Subtasks

- [ ] Task 1: Initialize frontend project (AC: 1, 4)
  - [ ] 1.1 Create React project with Vite in `/web` directory
  - [ ] 1.2 Configure TypeScript with strict mode
  - [ ] 1.3 Install and configure Tailwind CSS
  - [ ] 1.4 Install Shadcn/ui and initialize with project theme
  - [ ] 1.5 Install Lucide React icons
  - [ ] 1.6 Configure path aliases (`@/` for `src/`)
  - [ ] 1.7 Add `web` script commands to root package.json or create web/package.json
  - [ ] 1.8 Update `.idx/dev.nix` to enable Node.js and web preview

- [ ] Task 2: Configure PWA (AC: 1, 3)
  - [ ] 2.1 Install vite-plugin-pwa
  - [ ] 2.2 Create `public/manifest.json` with app name, icons, theme colors
  - [ ] 2.3 Generate PWA icons using pwa-asset-generator or create simple placeholder icons (solid #1E3A5F background with "FB" text in white, 192x192 and 512x512 PNG)
  - [ ] 2.4 Configure service worker for app shell caching (precache strategy)
  - [ ] 2.5 Add meta tags for PWA (theme-color, apple-touch-icon, etc.)
  - [ ] 2.6 Create `src/hooks/usePWAInstall.ts` to capture and defer `beforeinstallprompt` event
  - [ ] 2.7 Create `src/components/ui/InstallPrompt.tsx` for custom install banner
  - [ ] 2.8 Show install prompt after first successful login (not on first visit)
  - [ ] 2.9 Store `hasPromptedInstall` in localStorage to avoid re-prompting
  - [ ] 2.10 Test PWA installability in Chrome DevTools â†’ Application â†’ Manifest

- [ ] Task 3: Set up Firebase client SDK (AC: 6, 7)
  - [ ] 3.1 Install firebase client SDK (`firebase`)
  - [ ] 3.2 Create `src/lib/firebase.ts` with Firebase config
  - [ ] 3.3 Create `src/contexts/AuthContext.tsx` with auth state management
  - [ ] 3.4 Implement `useAuth` hook returning user, loading, signIn, signOut
  - [ ] 3.5 Configure Firebase Auth emulator connection for development
  - [ ] 3.6 Create environment variables for Firebase config (`.env.local`)

- [ ] Task 4: Implement app shell layout (AC: 2, 4, 5)
  - [ ] 4.1 Create `src/components/layout/AppShell.tsx` (main layout wrapper)
  - [ ] 4.2 Create `src/components/layout/AIBar.tsx` (placeholder, non-functional)
  - [ ] 4.3 Create `src/components/layout/BottomNav.tsx` (mobile: 3 tabs)
  - [ ] 4.4 Create `src/components/layout/SideNav.tsx` (desktop: sidebar)
  - [ ] 4.5 Implement responsive breakpoint switching (bottom nav < 1024px, side nav >= 1024px)
  - [ ] 4.6 Apply design system colors from front-end-spec.md Â§6.2
  - [ ] 4.7 Apply typography scale from front-end-spec.md Â§6.3

- [ ] Task 5: Implement routing (AC: 2)
  - [ ] 5.1 Install React Router (`react-router-dom`)
  - [ ] 5.2 Create `src/pages/InboxPage.tsx` (placeholder: centered "Inbox" heading + "Coming in Story 11.4" subtext)
  - [ ] 5.3 Create `src/pages/ClubPage.tsx` (placeholder: centered "My Club" heading + "Coming soon" subtext)
  - [ ] 5.4 Create `src/pages/BrowsePage.tsx` (placeholder: centered "Browse" heading + "Coming soon" subtext)
  - [ ] 5.5 Create `src/pages/LoginPage.tsx` with Firebase Auth UI
  - [ ] 5.6 Create `src/components/auth/ProtectedRoute.tsx` wrapper
  - [ ] 5.7 Configure routes in `src/App.tsx`
  - [ ] 5.8 Create `src/components/ui/LoadingSpinner.tsx` for auth loading state

- [ ] Task 6: Implement authentication flow (AC: 6, 7)
  - [ ] 6.1 Create login page with email/password form
  - [ ] 6.2 Add Google sign-in button (optional, if configured)
  - [ ] 6.3 Implement sign-out functionality in user menu
  - [ ] 6.4 Redirect unauthenticated users to login
  - [ ] 6.5 Redirect authenticated users from login to Inbox
  - [ ] 6.6 Show loading state while auth initializes
  - [ ] 6.7 Display inline error messages for failed login (invalid credentials, user not found)
  - [ ] 6.8 Handle network errors with "Unable to connect. Check your connection and try again."
  - [ ] 6.9 Clear error messages when user starts typing again

- [ ] Task 7: Configure Firebase Hosting build (AC: 1)
  - [ ] 7.1 Update `firebase.json` hosting.public to point to `web/dist`
  - [ ] 7.2 Add build script: `npm run build` outputs to `web/dist`
  - [ ] 7.3 Configure Vite base path for Firebase Hosting
  - [ ] 7.4 Test local build and preview with `firebase serve`

- [ ] Task 8: Write component tests (AC: 1, 2, 4, 5, 6, 7)
  - [ ] 8.1 Install Vitest and React Testing Library
  - [ ] 8.2 Create `src/__tests__/components/BottomNav.test.tsx`
  - [ ] 8.3 Create `src/__tests__/components/AppShell.test.tsx`
  - [ ] 8.4 Create `src/__tests__/components/ProtectedRoute.test.tsx`
  - [ ] 8.5 Create `src/__tests__/contexts/AuthContext.test.tsx`
  - [ ] 8.6 Create `src/__tests__/pages/LoginPage.test.tsx`
  - [ ] 8.7 Create `src/__tests__/hooks/usePWAInstall.test.tsx`
  - [ ] 8.8 Test: Bottom nav renders 3 tabs (Inbox, Club, Browse)
  - [ ] 8.9 Test: Navigation highlights active tab
  - [ ] 8.10 Test: AI Bar placeholder renders at top with disabled mic icon
  - [ ] 8.11 Test: ProtectedRoute redirects unauthenticated users
  - [ ] 8.12 Test: ProtectedRoute allows authenticated users
  - [ ] 8.13 Test: Auth context provides user state
  - [ ] 8.14 Test: Responsive layout switches at breakpoint
  - [ ] 8.15 Test: Login form displays error on invalid credentials
  - [ ] 8.16 Test: Login form displays network error message
  - [ ] 8.17 Test: Error message clears when user types
  - [ ] 8.18 Test: PWA install prompt shows after successful login
  - [ ] 8.19 Test: PWA install prompt not shown if already prompted (localStorage)
  - [ ] 8.20 Test: App shell displays offline banner when network unavailable

## Dev Notes

### Architecture Context
[Source: Architecture v1 Â§2.1 Client]

**Client Requirements:**
- Progressive Web App (PWA)
- Mobile-first, touch-optimised
- AI-first interface (AI bar placeholder in this story, functional in Story 11.2)
- Offline-read tolerant (cached rosters, shows, proposals)
- Deep-link landing pages for no-login proposal responses (future story)

**Firebase Services Used:**
- Firebase Auth â€” user identity
- Firebase Hosting â€” app + deep-link routes

### Design System
[Source: front-end-spec.md Â§5, Â§6]

**Component Library:** Shadcn/ui (headless, customizable)

**Color Palette:**
```css
--primary: #1E3A5F        /* Navigation, headers, primary buttons */
--primary-light: #2E5A8F  /* Hover states, active elements */
--secondary: #F5F5F5      /* Backgrounds, card surfaces */
--accent: #3B82F6         /* Links, AI elements, interactive highlights */
--success: #22C55E        /* Positive feedback, accepted, compliant */
--warning: #F59E0B        /* Cautions, pending states, advisory */
--error: #EF4444          /* Errors, declined, non-compliant */
--neutral-900: #111827    /* Primary text */
--neutral-600: #4B5563    /* Secondary text */
--neutral-300: #D1D5DB    /* Borders, dividers */
--neutral-100: #F3F4F6    /* Subtle backgrounds */
```

**Typography:**
- Primary font: Inter (or system-ui fallback)
- Body: 16px / 1rem, weight 400
- H1: 28px / 1.75rem, weight 700
- H2: 24px / 1.5rem, weight 600
- H3: 20px / 1.25rem, weight 600

**Icons:** Lucide Icons (outline style, 24px default)

### Layout Architecture
[Source: front-end-spec.md Â§2.1]

**Mobile Layout:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ¤– AI Bar [Ask anything...]    â”‚  â† Persistent top bar
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                 â”‚
â”‚       Main Content Area         â”‚  â† Scrollable content
â”‚                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ“¥ Inbox  â”‚ ğŸ  Club â”‚ ğŸ” Browse â”‚  â† Bottom nav
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Desktop Layout (â‰¥1024px):**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ¤– AI Bar [Ask anything...]              [User Menu]   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Inbox   â”‚                                             â”‚
â”‚  Club    â”‚          Main Content Area                  â”‚
â”‚  Browse  â”‚                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Breakpoints:**
| Breakpoint | Min Width | Layout |
|------------|-----------|--------|
| Mobile | 320px | Bottom nav, single column |
| Tablet | 768px | Bottom nav, wider cards |
| Desktop | 1024px | Side nav, multi-column capable |

### Navigation Icons
[Source: front-end-spec.md Â§6.4]

| Tab | Icon | Lucide Name |
|-----|------|-------------|
| Inbox | Mail/Bell | `inbox` or `bell` |
| Club | Home | `home` |
| Browse | Search | `search` |

### AI Bar Placeholder (Non-Functional in this Story)
[Required for AC: 5]

The AI Bar in this story is a **visual placeholder only** â€” full functionality comes in Story 11.2.

**Appearance:**
- Fixed position at top of screen
- Height: 56px
- Background: white with subtle bottom border (`--neutral-300`)
- Contains: Robot icon (Lucide `bot`), input field with placeholder "Ask anything...", mic icon (Lucide `mic`), send button (Lucide `send`)
- All elements styled but disabled (opacity 0.6)

**Behavior:**
- Clicking input shows toast: "AI assistant coming in the next update"
- Clicking mic shows toast: "Voice input coming soon"
- Input field is read-only, cannot accept text
- No actual input handling in this story

**Why placeholder?** This story establishes the shell layout. Story 11.2 (immediately following) adds full AI Bar functionality connecting to the `findMatch` backend. Story 11.3 adds voice input.

### PWA Configuration
[Source: front-end-spec.md Â§8.3]

**Manifest Requirements:**
- name: "FirstBell"
- short_name: "FirstBell"
- start_url: "/"
- display: "standalone"
- theme_color: "#1E3A5F"
- background_color: "#FFFFFF"
- icons: 192x192, 512x512 (PNG)

**Service Worker Strategy:**
- Precache app shell (HTML, CSS, JS, fonts)
- Network-first for API calls
- Cache-first for static assets

**Install Prompt Timing:**
- Do NOT show install prompt on first visit
- Capture `beforeinstallprompt` event and defer
- Show custom install prompt after user completes first successful action (e.g., login, view roster)
- Store `hasPromptedInstall` in localStorage to avoid re-prompting
- Provide manual "Add to Home Screen" option in settings/menu

### Firebase Configuration
[Source: firebase.json]

**Hosting Config (already exists):**
- Public directory: needs update to `web/dist`
- SPA rewrite: `**` â†’ `/index.html`
- Emulators: Auth (9099), Hosting (5000)

**Auth Provider:**
- Email/password (primary)
- Google sign-in (optional)

### Authentication Error Handling
[Required for AC: 6, 7]

**Firebase Auth Error Codes to Handle:**
| Error Code | User Message |
|------------|--------------|
| `auth/invalid-credential` | "Invalid email or password. Please try again." |
| `auth/user-not-found` | "No account found with this email." |
| `auth/wrong-password` | "Invalid email or password. Please try again." |
| `auth/too-many-requests` | "Too many failed attempts. Please try again later." |
| `auth/network-request-failed` | "Unable to connect. Check your connection and try again." |
| Default/unknown | "Something went wrong. Please try again." |

**Error Display Pattern:**
- Display error inline below the form (not alert/toast)
- Use `--error` color (#EF4444) for error text
- Clear error when user modifies any form field
- Keep form inputs populated on error (don't clear)

### Loading & Offline States
[Required for AC: 3, 6, 7]

**Auth Loading State:**
- While Firebase Auth initializes, show full-screen centered spinner with "Loading..." text
- Do not flash login page before auth state is known
- Use `onAuthStateChanged` observer, not one-time check

**Offline Behavior (MVP - Basic):**
- Service worker caches app shell (HTML, CSS, JS)
- If offline and not logged in: show "You're offline. Connect to sign in."
- If offline and logged in: show cached app shell, pages display "You're offline" banner at top
- No data fetching in this story â€” offline data sync is future work

### File Structure
```
web/
â”œâ”€â”€ public/
â”‚   â”œâ”€â”€ manifest.json
â”‚   â”œâ”€â”€ icon-192.png
â”‚   â”œâ”€â”€ icon-512.png
â”‚   â””â”€â”€ favicon.ico
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ layout/
â”‚   â”‚   â”‚   â”œâ”€â”€ AppShell.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ AIBar.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ BottomNav.tsx
â”‚   â”‚   â”‚   â””â”€â”€ SideNav.tsx
â”‚   â”‚   â”œâ”€â”€ auth/
â”‚   â”‚   â”‚   â””â”€â”€ ProtectedRoute.tsx
â”‚   â”‚   â””â”€â”€ ui/
â”‚   â”‚       â”œâ”€â”€ LoadingSpinner.tsx
â”‚   â”‚       â”œâ”€â”€ InstallPrompt.tsx    # PWA install banner
â”‚   â”‚       â””â”€â”€ ...                  # Shadcn components
â”‚   â”œâ”€â”€ contexts/
â”‚   â”‚   â””â”€â”€ AuthContext.tsx
â”‚   â”œâ”€â”€ hooks/
â”‚   â”‚   â””â”€â”€ usePWAInstall.ts         # PWA install prompt handling
â”‚   â”œâ”€â”€ lib/
â”‚   â”‚   â”œâ”€â”€ firebase.ts
â”‚   â”‚   â””â”€â”€ utils.ts                 # Shadcn cn() helper
â”‚   â”œâ”€â”€ pages/
â”‚   â”‚   â”œâ”€â”€ InboxPage.tsx
â”‚   â”‚   â”œâ”€â”€ ClubPage.tsx
â”‚   â”‚   â”œâ”€â”€ BrowsePage.tsx
â”‚   â”‚   â””â”€â”€ LoginPage.tsx
â”‚   â”œâ”€â”€ __tests__/
â”‚   â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ contexts/
â”‚   â”‚   â”œâ”€â”€ hooks/
â”‚   â”‚   â””â”€â”€ pages/
â”‚   â”œâ”€â”€ App.tsx
â”‚   â”œâ”€â”€ main.tsx
â”‚   â””â”€â”€ index.css                    # Tailwind + theme variables
â”œâ”€â”€ package.json
â”œâ”€â”€ vite.config.ts
â”œâ”€â”€ tailwind.config.js
â”œâ”€â”€ tsconfig.json
â””â”€â”€ .env.local                       # Firebase config (not committed)
```

### Performance Targets
[Source: front-end-spec.md Â§10.1]

| Metric | Target |
|--------|--------|
| First Contentful Paint | < 1.5s (3G) |
| Time to Interactive | < 3s (3G) |
| Largest Contentful Paint | < 2.5s (3G) |

### Accessibility Requirements
[Source: front-end-spec.md Â§7]

- WCAG 2.1 Level AA compliance
- Color contrast: 4.5:1 minimum for text
- Touch targets: 44x44px minimum
- Keyboard navigation for all features
- Semantic HTML structure

## Testing

### Test File Locations
- `web/src/__tests__/components/BottomNav.test.tsx`
- `web/src/__tests__/components/AppShell.test.tsx`
- `web/src/__tests__/components/ProtectedRoute.test.tsx`
- `web/src/__tests__/contexts/AuthContext.test.tsx`
- `web/src/__tests__/pages/LoginPage.test.tsx`
- `web/src/__tests__/hooks/usePWAInstall.test.tsx`

### Testing Framework
- Vitest (Vite-native test runner)
- React Testing Library
- @testing-library/jest-dom for matchers

### Testing Patterns
- Mock Firebase Auth for auth context tests
- Use `screen.getByRole` for accessibility-focused queries
- Test responsive behavior with `matchMedia` mocks
- Test navigation state changes

### Coverage Requirements
- All acceptance criteria must have corresponding tests
- Component tests for layout components
- Integration tests for auth flow
- Auth error handling tests (invalid credentials, network errors)
- PWA install prompt tests
- Minimum 20 test cases as listed in Task 8 (8.8-8.20 = 13 tests)

---

## Change Log
| Date | Author | Change |
|------|--------|--------|
| 2026-01-08 | Bob (SM) | UX Alignment: Added PWA install prompt timing (Task 2.6-2.9), usePWAInstall hook, InstallPrompt component, 3 additional tests (8.18-8.19). Updated file structure. |
| 2026-01-08 | Bob (SM) | Validation: Added auth error handling (Task 6.7-6.9), explicit error codes table, PWA icon generation guidance, additional test cases |
| 2026-01-08 | John (PM) | Initial draft |

---

## Dev Agent Record

### Agent Model Used
_(To be filled by dev agent)_

### Completion Notes
_(To be filled by dev agent)_

### DoD Checklist
- [ ] All acceptance criteria implemented and tested
- [ ] Unit tests written and passing
- [ ] PWA installable and passes Lighthouse PWA audit
- [ ] Responsive layout works on mobile and desktop
- [ ] Firebase Auth integration complete
- [ ] Build produces deployable output in web/dist
- [ ] No accessibility violations (axe-core)

---

## QA Results

### Review Date: 2026-01-08

### Reviewed By: Quinn (Test Architect)

### Review Type: Pre-Implementation

### Code Quality Assessment
N/A - Pre-implementation review (no code to review yet)

### Requirements Traceability

| AC | Description | Tasks | Tests | Status |
|----|-------------|-------|-------|--------|
| 1 | PWA installable | T1, T2, T7 | 8.18, 8.19 | âœ“ Covered |
| 2 | Bottom nav 3 tabs | T4.3, T5 | 8.8, 8.9 | âœ“ Covered |
| 3 | Offline-read tolerant | T2.4 | 8.20 | âœ“ Covered |
| 4 | Responsive design | T1, T4.5 | 8.14 | âœ“ Covered |
| 5 | AI Bar placeholder | T4.2 | 8.10 | âœ“ Covered |
| 6 | Firebase Auth | T3, T6 | 8.11-8.13, 8.15-8.17 | âœ“ Covered |
| 7 | Auth routing | T5.6, T6 | 8.11, 8.12 | âœ“ Covered |

### Compliance Check
- Story Structure: âœ“ Complete
- Acceptance Criteria: âœ“ Clear and testable
- Tasks/Subtasks: âœ“ Comprehensive (59 subtasks)
- Dev Notes: âœ“ Excellent (design system, layouts, error codes)
- Test Cases: âœ“ All 20 cases mapped to ACs

### Findings

**Strengths:**
- Excellent design system documentation (colors, typography, layouts)
- Comprehensive auth error handling with specific Firebase error codes
- PWA install prompt timing well-specified (deferred until first login)
- Clear file structure and component organization

**Gap Resolved:**
- ~~**TEST-001** (Low): AC3 (offline-read tolerant) has no explicit test case~~
  - **Fixed**: Added test 8.20: "App shell displays offline banner when network unavailable"

### Security Review
- âœ“ Auth required for protected routes (Task 5.6)
- âœ“ Firebase config via environment variables (Task 3.6)
- âœ“ Error messages don't leak sensitive info (Task 6.7-6.9)

### Performance Considerations
- âœ“ Targets defined: FCP <1.5s, TTI <3s, LCP <2.5s
- âœ“ Service worker caching strategy documented

### Gate Status
**Gate: PASS** â†’ `docs/qa/gates/11.1-pwa-shell-navigation.yml`

### Recommended Actions
None - all gaps resolved.

### Recommended Status
âœ“ Ready for Implementation
