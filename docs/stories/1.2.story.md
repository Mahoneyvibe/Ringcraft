# Story 1.2: Platform Admin Role

## Status
Ready for Review

## Story
**As a** platform owner,
**I want** a distinct admin role,
**so that** I can manage clubs and resolve issues.

## Acceptance Criteria
1. Platform admin identified via custom claim `isPlatformAdmin=true`
2. Platform admin permissions are separate from club membership

## Tasks / Subtasks

- [x] Task 1: Create admin management Cloud Function (AC: 1)
  - [x] 1.1 Create `functions/src/admin/setAdminClaim.ts` module
  - [x] 1.2 Implement callable function to set `isPlatformAdmin` claim
  - [x] 1.3 Restrict function to existing admins only (bootstrap via script)
  - [x] 1.4 Export function from `functions/src/index.ts`

- [x] Task 2: Create bootstrap script for first admin (AC: 1)
  - [x] 2.1 Create `functions/scripts/bootstrap-admin.ts`
  - [x] 2.2 Script sets `isPlatformAdmin=true` on specified UID
  - [x] 2.3 Add safety guard: only runs against emulator OR requires confirmation for prod
  - [x] 2.4 Document usage in script comments

- [x] Task 3: Write unit tests for setAdminClaim (AC: 1, 2)
  - [x] 3.1 Test: Existing admin can grant admin to another user
  - [x] 3.2 Test: Non-admin cannot call setAdminClaim (permission denied)
  - [x] 3.3 Test: Admin claim is independent of clubMemberships (AC: 2)
  - [x] 3.4 Test: Custom claim appears in auth token

- [x] Task 4: Validate security rules recognize admin claim (AC: 1, 2)
  - [x] 4.1 Test: `isPlatformAdmin()` helper returns true for admin
  - [x] 4.2 Test: Admin can read `admin/auditLogs`
  - [x] 4.3 Test: Admin can update user docs (per rules)
  - [x] 4.4 Test: Admin access works regardless of clubMemberships (AC: 2)

- [x] Task 5: Create audit log entry for admin grants
  - [x] 5.1 Write to `admin/auditLogs` when admin claim is set
  - [x] 5.2 Include: actorId, targetId, action, timestamp

## Dev Notes

### Custom Claims Structure
[Source: Firebase implementation plan.md §3.2]

```typescript
interface CustomClaims {
  isPlatformAdmin?: boolean;  // Platform admin access
  // Club membership NOT in claims (read from Firestore)
}
```

**Key Architectural Decision:** Club membership is stored in Firestore (`users/{userId}.clubMemberships`), NOT in custom claims. This keeps claims small and allows real-time membership updates without re-authentication.

### Setting Admin Claim (Admin SDK)
[Source: Firebase implementation plan.md §3.2]

```typescript
await admin.auth().setCustomUserClaims(uid, { isPlatformAdmin: true });
```

**Important:** After setting custom claims, the user must refresh their ID token to see the new claim. This happens automatically within 1 hour, or immediately on re-authentication.

### Auth State Requirements
[Source: Firebase implementation plan.md §3.3]

| Action | Auth Required | Additional Check |
|--------|---------------|------------------|
| Admin actions | Yes | `isPlatformAdmin: true` |

### Security Rules (Already Deployed)
[Source: firestore.rules]

```javascript
function isPlatformAdmin() {
  return isAuthenticated() &&
         request.auth.token.isPlatformAdmin == true;
}

// Admin can update any user
match /users/{userId} {
  allow update: if request.auth.uid == userId || isPlatformAdmin();
}

// Only admin can read audit logs
match /admin/auditLogs/{logId} {
  allow read: if isPlatformAdmin();
  allow create: if false;  // Cloud Functions only
}
```

### Audit Log Schema
[Source: Firebase implementation plan.md §1.8]

```typescript
// admin/auditLogs/{logId}
interface AuditLog {
  logId: string;
  action: string;              // e.g., 'admin.claim.granted'
  actorId: string;             // userId who performed action
  actorType: 'admin' | 'system';
  targetType: string;          // 'user'
  targetId: string;            // userId receiving claim
  targetClubId: string | null; // null for admin actions
  details: object;             // { claim: 'isPlatformAdmin', value: true }
  timestamp: Timestamp;
  ipAddress: string | null;
}
```

**Invariant:** Audit logs are append-only and immutable. [Source: Architecture doc §4.7]

### File Locations

| File | Purpose |
|------|---------|
| `functions/src/admin/setAdminClaim.ts` | Callable function to grant admin |
| `functions/scripts/bootstrap-admin.ts` | First admin bootstrap script |
| `functions/src/index.ts` | Export the function |
| `functions/src/__tests__/admin/setAdminClaim.test.ts` | Unit tests |

### Architecture Constraints
[Source: Code Execution Brief §1]

- All admin actions are audited
- Admin permissions are separate from club membership (AC: 2)
- Custom claims are set via Admin SDK only (not client-writable)

### Bootstrap Process

Since you can't grant admin without being admin, the first admin must be bootstrapped:

1. Run `bootstrap-admin.ts` script with target UID
2. Script uses Admin SDK directly (not a callable function)
3. Script writes audit log entry
4. After bootstrap, use `setAdminClaim` callable for subsequent admins

## Testing

### Test Framework
- Firebase Emulator Suite for integration tests
- Jest for unit tests

### Test Location
`functions/src/__tests__/admin/`

### Required Tests
1. **Bootstrap script:** Successfully sets claim on target user
2. **Callable function:** Admin can grant admin to another user
3. **Permission check:** Non-admin cannot call setAdminClaim
4. **Separation:** Admin claim works independently of club membership
5. **Audit logging:** All admin grants are logged
6. **Token refresh:** Claim appears in token after refresh

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-05 | 1.0 | Initial draft | SM Agent (Bob) |
| 2025-01-05 | 1.1 | Implementation complete, all tasks done | Dev Agent (James) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
- Updated firestore.rules: Changed `admin/auditLogs/{logId}` to `admin/auditLogs/entries/{logId}` for valid Firestore subcollection pattern
- Fixed TypeScript type inference in tests by using `any` type assertion for mocked callable function

### Completion Notes List
- setAdminClaim callable function verifies caller has isPlatformAdmin claim before allowing grant/revoke
- Bootstrap script has safety guards: runs freely against emulator, requires --confirm for production
- Audit logs written to `admin/auditLogs/entries/{logId}` subcollection
- All admin actions are logged with actorId, targetId, action, timestamp, and IP address
- Admin claim is completely independent of clubMemberships (stored in Firestore, not claims)

### File List
| File | Action | Purpose |
|------|--------|---------|
| `functions/src/admin/setAdminClaim.ts` | Created | Callable function to grant/revoke admin |
| `functions/src/index.ts` | Modified | Added admin function export |
| `functions/scripts/bootstrap-admin.ts` | Created | Bootstrap script for first admin |
| `functions/src/__tests__/admin/setAdminClaim.test.ts` | Created | Unit tests with mocks |
| `functions/src/__tests__/rules/admin.rules.test.ts` | Created | Security rules tests for admin claim |
| `firestore.rules` | Modified | Fixed audit logs subcollection path |

---

## QA Results

### Review Date: 2025-01-05

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall: Excellent** - Robust security implementation with comprehensive audit logging.

Strengths:
- Multi-layer security: auth check → admin claim check → input validation → user existence check
- Complete audit logging with actorId, targetId, action, timestamp, IP address
- Bootstrap script with safety guards (emulator auto-allowed, production requires --confirm)
- Clean separation between callable function (runtime) and bootstrap script (initial setup)
- Proper HttpsError codes for different failure modes

### Refactoring Performed

None required - security implementation is production-ready.

### Compliance Check

- Coding Standards: ✓ ESLint passes, proper TypeScript usage
- Project Structure: ✓ Files in correct locations per story spec
- Testing Strategy: ✓ Unit tests (13) + security rules tests (11)
- All ACs Met: ✓ Both acceptance criteria fully implemented and tested

### Requirements Traceability

| AC# | Requirement | Test Coverage | Status |
|-----|-------------|---------------|--------|
| 1 | Admin via `isPlatformAdmin=true` claim | Unit: grant/revoke tests; Rules: isPlatformAdmin() tests | ✓ |
| 2 | Admin separate from club membership | Unit: independence tests; Rules: AC:2 section (3 tests) | ✓ |

### Improvements Checklist

- [x] Callable function restricts to existing admins only
- [x] Bootstrap script for first admin with safety guards
- [x] All admin actions audited
- [x] Admin claim independent of clubMemberships
- [x] Input validation (targetUid, isAdmin required)
- [x] User existence verification before setting claim
- [ ] Consider adding rate limiting to setAdminClaim (future security enhancement)
- [ ] Consider adding admin revocation self-protection (prevent last admin from revoking themselves)

### Security Review

✓ **Excellent** - Multiple security layers implemented:
1. Authentication required (unauthenticated → 401)
2. Admin claim required (non-admin → 403 permission-denied)
3. Input validation prevents injection
4. Target user existence verified
5. All actions audit logged with IP address
6. Bootstrap script prevents accidental production modifications

### Performance Considerations

✓ **No concerns** - Two async operations (setCustomUserClaims + audit log write). Could be parallelized but sequential is safer for audit integrity.

### Files Modified During Review

None - no refactoring required.

### Gate Status

**Gate: PASS** → docs/qa/gates/1.2-platform-admin-role.yml

### Recommended Status

✓ **Ready for Done** - Both acceptance criteria met, robust security implementation, comprehensive audit logging.
