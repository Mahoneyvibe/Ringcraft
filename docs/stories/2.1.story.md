# Story 2.1: Pre-Seeded Club Directory

## Status
Ready for Review

## Story
**As a** club official,
**I want** to search for my club,
**So that** I can claim it.

## Acceptance Criteria
1. Clubs exist in Firestore with `status=unclaimed`
2. Club name and region are searchable by authenticated users

## Tasks / Subtasks

- [x] Task 1: Create club seed data file (AC: 1)
  - [x] 1.1 Create `functions/data/seed-clubs.json` with sample clubs
  - [x] 1.2 Include required fields: name, region, status='unclaimed'
  - [x] 1.3 Add at least 10 representative clubs across different regions

- [x] Task 2: Create club seed script (AC: 1)
  - [x] 2.1 Create `functions/scripts/seed-clubs.ts`
  - [x] 2.2 Script reads from seed data file and writes to Firestore
  - [x] 2.3 Add safety guard: only runs against emulator OR requires confirmation for prod
  - [x] 2.4 Script is idempotent (skips existing clubs by ID)
  - [x] 2.5 Document usage in script comments

- [x] Task 3: Create Club TypeScript interface (AC: 1, 2)
  - [x] 3.1 Create `functions/src/types/club.ts` with Club interface
  - [x] 3.2 Include all fields from schema: name, region, status, claimedBy, claimedAt, contactEmail, contactPhone, createdAt, updatedAt
  - [x] 3.3 Export ClubStatus type union

- [x] Task 4: Create searchClubs Cloud Function (AC: 2)
  - [x] 4.1 Create `functions/src/clubs/searchClubs.ts` callable function
  - [x] 4.2 Accept search parameters: query (string), region (optional)
  - [x] 4.3 Return matching clubs (name, region, status only - no contact info)
  - [x] 4.4 Require authentication
  - [x] 4.5 Export function from `functions/src/index.ts`

- [x] Task 5: Update Firestore security rules (AC: 2)
  - [x] 5.1 Add rule: authenticated users can read club documents
  - [x] 5.2 Ensure club creation remains admin/script only (no client writes)
  - [x] 5.3 Ensure contactPhone is never exposed in reads (handled by Cloud Function)

- [x] Task 6: Write unit tests for searchClubs (AC: 2)
  - [x] 6.1 Test: Unauthenticated user cannot search (permission denied)
  - [x] 6.2 Test: Search by name returns matching clubs
  - [x] 6.3 Test: Search by region filters correctly
  - [x] 6.4 Test: Results exclude sensitive fields (contactPhone)
  - [x] 6.5 Test: Empty search returns error or empty results

- [x] Task 7: Write security rules tests (AC: 1, 2)
  - [x] 7.1 Test: Authenticated user can read club document
  - [x] 7.2 Test: Unauthenticated user cannot read club document
  - [x] 7.3 Test: Client cannot create club document
  - [x] 7.4 Test: Client cannot update club document directly

## Dev Notes

### Club Schema
[Source: Firebase implementation plan.md §1.2]

```typescript
// clubs/{clubId}
interface Club {
  clubId: string;
  name: string;
  region: string;
  status: 'unclaimed' | 'claim_pending' | 'claimed' | 'suspended';
  claimedBy: string | null;       // userId who claimed
  claimedAt: Timestamp | null;
  contactEmail: string | null;
  contactPhone: string | null;    // NEVER exposed publicly
  createdAt: Timestamp;
  updatedAt: Timestamp;
}
```

**Invariant:** Clubs are never deleted. [Source: Architecture doc]

### Security Rules
[Source: Firebase implementation plan.md §4.2]

```javascript
match /clubs/{clubId} {
  // Anyone authenticated can read club info (for discovery)
  allow read: if isAuthenticated();

  // Clubs are pre-seeded only - no client creation
  allow create: if false;

  // Updates handled by Cloud Functions (claim flow)
  allow update: if false;
}
```

**Key Decision:** Club creation is disabled for clients. Pre-seeding happens via admin script.

### Search Implementation Notes

Since Firestore doesn't support full-text search natively, the searchClubs function should:
1. Use `where` clause for exact region matches
2. For name search, retrieve clubs and filter in-memory (MVP approach)
3. Consider Algolia or Typesense for future full-text search needs

**MVP Approach:** Given the limited number of clubs (~200-500 in UK amateur boxing), client-side filtering is acceptable for MVP. The Cloud Function fetches all unclaimed clubs and filters by name/region.

### Auth State Requirements
[Source: Firebase implementation plan.md §3.3]

| Action | Auth Required | Additional Check |
|--------|---------------|------------------|
| Search clubs | Yes | None |
| Read club details | Yes | None |

### File Locations

| File | Purpose |
|------|---------|
| `functions/data/seed-clubs.json` | Club seed data |
| `functions/scripts/seed-clubs.ts` | Seed script |
| `functions/src/types/club.ts` | Club TypeScript interface |
| `functions/src/clubs/searchClubs.ts` | Search callable function |
| `functions/src/index.ts` | Export functions |
| `functions/src/__tests__/clubs/searchClubs.test.ts` | Unit tests |
| `functions/src/__tests__/rules/clubs.rules.test.ts` | Security rules tests |

### Architecture Constraints
[Source: Code Execution Brief §1]

- Clubs are pre-seeded, never client-created
- contactPhone is never exposed to clients
- All club reads require authentication

## Testing

### Test Framework
- Firebase Emulator Suite for integration tests
- Jest for unit tests

### Test Location
`functions/src/__tests__/clubs/`

### Required Tests
1. **Seed script:** Successfully seeds clubs to emulator
2. **Search function:** Returns matching clubs by name
3. **Region filter:** Filters by region correctly
4. **Auth required:** Unauthenticated requests rejected
5. **Data privacy:** contactPhone not included in results
6. **Security rules:** Client cannot create/update clubs

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-05 | 1.0 | Initial draft | SM Agent (Bob) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
- No debug issues encountered

### Completion Notes List
- Created 12 sample UK amateur boxing clubs across different regions (London, Yorkshire, North West, etc.)
- Seed script follows same safety pattern as bootstrap-admin.ts (emulator auto-allowed, production requires --confirm)
- searchClubs callable function requires authentication, returns only public fields (no contactPhone)
- MVP search approach: Firestore query for region filter, in-memory filtering for partial name match
- ClubSearchResult type explicitly excludes contactPhone and contactEmail for data privacy
- Security rules already existed for clubs collection from initial firestore.rules setup

### File List
| File | Action | Purpose |
|------|--------|---------|
| `functions/data/seed-clubs.json` | Created | Club seed data with 12 UK boxing clubs |
| `functions/scripts/seed-clubs.ts` | Created | Idempotent seed script with safety guards |
| `functions/src/types/club.ts` | Created | Club, ClubStatus, ClubSearchResult interfaces |
| `functions/src/clubs/searchClubs.ts` | Created | Callable function for club search |
| `functions/src/index.ts` | Modified | Added searchClubs export |
| `functions/src/__tests__/clubs/searchClubs.test.ts` | Created | 18 unit tests for searchClubs |
| `functions/src/__tests__/rules/clubs.rules.test.ts` | Created | 11 security rules tests |

---

## QA Results

### Review Date: 2025-01-05

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall: Excellent** - Clean implementation following established patterns from Sprint 0.

Strengths:
- Consistent safety pattern in seed script (emulator auto-allowed, production requires --confirm)
- Clean type separation: Club (full), ClubSearchResult (public), SearchClubsRequest/Response
- Privacy by design: toSearchResult() explicitly strips contactPhone/contactEmail
- MVP search approach well-documented with future scaling notes

### Refactoring Performed

None required - implementation is production-ready.

### Compliance Check

- Coding Standards: ✓ ESLint passes, consistent TypeScript patterns
- Project Structure: ✓ Files in correct locations per story spec
- Testing Strategy: ✓ Unit tests (18) + security rules tests (11)
- All ACs Met: ✓ Both acceptance criteria fully implemented and tested

### Requirements Traceability

| AC# | Requirement | Test Coverage | Status |
|-----|-------------|---------------|--------|
| 1 | Clubs exist with status=unclaimed | Seed data + rules tests (create denied) | ✓ |
| 2 | Name/region searchable by auth users | Unit: auth, search, region, privacy (18 tests) | ✓ |

### Improvements Checklist

- [x] Seed script idempotent and safe
- [x] Authentication required for search
- [x] Sensitive fields excluded from results
- [x] Region filter at query level (efficient)
- [x] Name filter in-memory (MVP acceptable)
- [ ] Consider pagination when club count exceeds ~500 (future)
- [ ] Consider Algolia/Typesense for full-text search (future)

### Security Review

✓ **PASS** - Multiple security layers:
1. Authentication required (unauthenticated → 401)
2. toSearchResult() strips sensitive fields (contactPhone, contactEmail)
3. Security rules: clients cannot create/update/delete clubs
4. Admin cannot bypass rules via client (Cloud Functions only)

### Performance Considerations

✓ **PASS** - MVP approach acceptable:
- Region filter at Firestore query level (efficient)
- In-memory name filtering for ~200-500 clubs is performant
- Future: pagination + search service when scale requires

### Files Modified During Review

None - no refactoring required.

### Gate Status

**Gate: PASS** → docs/qa/gates/2.1-pre-seeded-club-directory.yml

### Recommended Status

✓ **Ready for Done** - Both acceptance criteria met, solid security implementation, comprehensive test coverage.
