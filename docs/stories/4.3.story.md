# Story 4.3: Edit Boxer Profile

## Status
Done

## Story
**As a** club official,
**I want** to edit boxer details,
**So that** matchmaking remains accurate.

## Acceptance Criteria
1. Only owning club members may edit
2. Updates record editor and timestamp

## Tasks / Subtasks

- [x] Task 1: Create updateBoxer callable function (AC: 1, 2)
  - [x] 1.1 Create `functions/src/roster/updateBoxer.ts`
  - [x] 1.2 Verify caller is authenticated
  - [x] 1.3 Verify caller is a member of the target club
  - [x] 1.4 Verify boxer exists and belongs to club
  - [x] 1.5 Validate editable fields (reject boxerId, createdAt, createdBy changes)
  - [x] 1.6 Update boxer with provided fields
  - [x] 1.7 Set `updatedAt` to current timestamp
  - [x] 1.8 Set `lastModifiedBy` to caller's userId
  - [x] 1.9 Return updated boxer data
  - [x] 1.10 Export function from `functions/src/index.ts`

- [x] Task 2: Add request/response types (AC: 1, 2)
  - [x] 2.1 Add `UpdateBoxerRequest` to `functions/src/types/boxer.ts`
  - [x] 2.2 Add `UpdateBoxerResponse` to `functions/src/types/boxer.ts`

- [x] Task 3: Write unit tests for updateBoxer (AC: 1, 2)
  - [x] 3.1 Test: Unauthenticated user cannot update boxer
  - [x] 3.2 Test: User not in club cannot update boxer
  - [x] 3.3 Test: Cannot update boxer that does not exist
  - [x] 3.4 Test: Cannot update boxer from another club
  - [x] 3.5 Test: Valid request updates boxer fields
  - [x] 3.6 Test: updatedAt is set to current timestamp
  - [x] 3.7 Test: lastModifiedBy is set to caller userId
  - [x] 3.8 Test: Cannot modify boxerId field
  - [x] 3.9 Test: Cannot modify createdAt field
  - [x] 3.10 Test: Cannot modify createdBy field
  - [x] 3.11 Test: Partial updates work (only specified fields change)
  - [x] 3.12 Test: Returns updated boxer data
  - [x] 3.13 Test: Empty updates object returns error
  - [x] 3.14 Test: Invalid field type returns error

## Dev Notes

### Previous Story Insights
[Source: Story 4.2]
- Boxer types defined in `functions/src/types/boxer.ts`
- Roster functions in `functions/src/roster/` directory
- Test patterns established in `functions/src/__tests__/roster/`
- Currently 137 tests passing

### Data Model

#### Boxer Document
[Source: Firebase implementation plan.md §1.2.2]

```typescript
// clubs/{clubId}/boxers/{boxerId}
interface Boxer {
  boxerId: string;               // IMMUTABLE
  firstName: string;
  lastName: string;
  dob: Timestamp;
  gender: 'male' | 'female';
  category: string;
  declaredWeight: number;
  declaredBouts: number;
  declaredWins: number;
  declaredLosses: number;
  dataStatus: 'draft' | 'active' | 'archived';
  availability: 'available' | 'unavailable' | 'injured';
  notes: string | null;
  createdAt: Timestamp;          // IMMUTABLE
  updatedAt: Timestamp;          // AUTO-SET by function
  createdBy: string;             // IMMUTABLE
  lastModifiedBy: string;        // AUTO-SET by function
}
```

### Field Editability

| Field | Editable | Notes |
|-------|----------|-------|
| boxerId | NO | Globally unique, immutable |
| firstName | YES | |
| lastName | YES | |
| dob | YES | |
| gender | YES | |
| category | YES | |
| declaredWeight | YES | |
| declaredBouts | YES | Manual adjustment allowed |
| declaredWins | YES | Manual adjustment allowed |
| declaredLosses | YES | Manual adjustment allowed |
| dataStatus | YES | Can change availability state |
| availability | YES | |
| notes | YES | Club-only notes |
| createdAt | NO | Set at creation |
| createdBy | NO | Set at creation |
| updatedAt | AUTO | Set by function |
| lastModifiedBy | AUTO | Set by function |

### Request/Response Types

```typescript
interface UpdateBoxerRequest {
  clubId: string;
  boxerId: string;
  updates: Partial<{
    firstName: string;
    lastName: string;
    dob: string;              // ISO date string, converted to Timestamp
    gender: 'male' | 'female';
    category: string;
    declaredWeight: number;
    declaredBouts: number;
    declaredWins: number;
    declaredLosses: number;
    dataStatus: 'draft' | 'active' | 'archived';
    availability: 'available' | 'unavailable' | 'injured';
    notes: string | null;
  }>;
}

interface UpdateBoxerResponse {
  success: boolean;
  boxer: Boxer;  // Updated boxer data
}
```

### Security Rules (Already Implemented)
[Source: Firebase implementation plan.md §4.2]

```
match /boxers/{boxerId} {
  allow read: if isAnyClubMember();
  allow create: if isClubMember(clubId);
  allow update: if isClubMember(clubId) &&
                  request.resource.data.boxerId == resource.data.boxerId;
  allow delete: if false;
}
```

Note: Security rules enforce boxerId immutability. Cloud Function adds additional validation for createdAt/createdBy and ensures updatedAt/lastModifiedBy are always set.

### Technical Constraints
- boxerId, createdAt, createdBy are immutable
- updatedAt and lastModifiedBy are always set by function (never from client)
- Partial updates supported (only provided fields are changed)
- Date fields (dob) accepted as ISO strings, converted to Timestamps
- No audit logging required (not in AC)

### Edge Cases
1. **Empty updates object**: Return error, at least one field required
2. **Invalid field values**: Validate types and constraints
3. **Archived boxer**: Can still be edited (may need to change status back)

## Testing

### Test File Location
- `functions/src/__tests__/roster/updateBoxer.test.ts`

### Testing Patterns
[Source: Existing test patterns]
- Mock Firebase Admin SDK (Firestore, Auth)
- Test authentication and authorization separately
- Test immutable field protection
- Test partial updates
- Follow patterns from `confirmRoster.test.ts`

### Coverage Requirements
- All acceptance criteria must have corresponding tests
- Test immutable field rejection
- Test partial update functionality
- Verify updatedAt and lastModifiedBy are set

## File List
- `functions/src/roster/updateBoxer.ts` (new) - Callable function
- `functions/src/types/boxer.ts` (modified) - Add request/response types
- `functions/src/index.ts` (modified) - Export new function
- `functions/src/__tests__/roster/updateBoxer.test.ts` (new) - Unit tests

## QA Results

### Pre-Implementation Review: 2026-01-07

**Reviewed By:** Quinn (Test Architect)

### Requirements Traceability

| AC | Tasks | Tests | Status |
|----|-------|-------|--------|
| 1 - Only owning club members may edit | Task 1.2, 1.3 | 3.1, 3.2, 3.4 | PASS |
| 2 - Updates record editor and timestamp | Task 1.7, 1.8 | 3.6, 3.7 | PASS |

All acceptance criteria are testable and have corresponding tasks and tests.

### Technical Approach Assessment

| Area | Status | Notes |
|------|--------|-------|
| Data Models | PASS | Uses existing Boxer interface |
| Security | PASS | Auth + club membership validation |
| Function Pattern | PASS | HTTPS Callable follows established pattern |
| Immutability | PASS | boxerId, createdAt, createdBy protected |
| Partial Updates | PASS | Only specified fields changed |

### Risk Assessment

| Risk | Probability | Impact | Score | Mitigation |
|------|-------------|--------|-------|------------|
| Invalid data saved | Low | Medium | 3 | Field validation in function |
| Concurrent edits | Very Low | Low | 1 | Last-write-wins acceptable for MVP |

**Overall Risk: LOW** — Simple CRUD operation with established patterns.

### Test Coverage Assessment

| Category | Count | Status |
|----------|-------|--------|
| Auth/authz tests | 4 | PASS |
| Success path tests | 3 | PASS |
| Immutability tests | 3 | PASS |
| Edge case tests | 4 | PASS |

**Total: 14 tests planned**

### Gaps Addressed

Added 2 test cases during review:
- Test 3.13: Empty updates object returns error
- Test 3.14: Invalid field type returns error

### NFR Validation (Pre-Implementation)

| Attribute | Status | Notes |
|-----------|--------|-------|
| Security | PASS | Auth checks, club membership validation |
| Performance | PASS | Single document update |
| Reliability | PASS | Simple atomic operation |
| Maintainability | PASS | Follows established patterns |

### Gate Status

**Gate: PASS** — Ready for implementation

---

### Post-Implementation Review: 2026-01-07

**Reviewed By:** Quinn (Test Architect)

### Implementation Verification

| Item | Expected | Actual | Status |
|------|----------|--------|--------|
| Function created | `updateBoxer.ts` | ✓ Created | PASS |
| Types added | BoxerUpdates, Request/Response | ✓ Added to `boxer.ts` | PASS |
| Export added | `index.ts` exports function | ✓ Exported | PASS |
| Tests created | 14 test cases | 25 test cases | PASS |
| All tests passing | Yes | 162/162 | PASS |
| Lint passing | Yes | ✓ | PASS |

### Requirements Traceability (Post-Implementation)

| AC | Implementation | Tests | Status |
|----|----------------|-------|--------|
| 1 - Only owning club members | Auth check (L195-200) + membership check (L238-252) | Tests 3.1, 3.2, 3.4 | VERIFIED |
| 2 - Updates editor and timestamp | `updatedAt: now` + `lastModifiedBy: userId` (L279-280) | Tests 3.6, 3.7 | VERIFIED |

### Code Quality Assessment

| Area | Status | Notes |
|------|--------|-------|
| Input validation | PASS | Comprehensive field and type validation |
| Immutability protection | PASS | boxerId, createdAt, createdBy rejected |
| Auto-set fields | PASS | updatedAt, lastModifiedBy always set |
| Error handling | PASS | Descriptive HttpsError messages |
| DOB conversion | PASS | ISO string to Timestamp |
| Logging | PASS | Uses `functions.logger` |

### Test Coverage Assessment (Post-Implementation)

| Category | Planned | Actual | Status |
|----------|---------|--------|--------|
| Auth/authz | 4 | 4 | PASS |
| Success path | 3 | 3 | PASS |
| Immutability | 3 | 3 | PASS |
| Edge cases | 4 | 8 | EXCEEDS |
| Input validation | 0 | 3 | BONUS |
| DOB handling | 0 | 2 | BONUS |
| Various fields | 0 | 2 | BONUS |

**Total: 25 tests** (exceeded 14 planned)

### Gate Decision

**Gate: PASS** — Implementation complete and verified

All acceptance criteria met, tests exceed requirements, code follows established patterns.

---

## Change Log
| Date | Author | Change |
|------|--------|--------|
| 2026-01-07 | Quinn (QA) | Pre-implementation review: PASS, added tests 3.13-3.14 |
| 2026-01-07 | John (PM) | Initial draft |
