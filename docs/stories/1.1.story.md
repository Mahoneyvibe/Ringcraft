# Story 1.1: User Authentication

## Status
Done

## Story
**As a** club official,
**I want** to sign up and log in securely,
**so that** I can access FirstBell features.

## Acceptance Criteria
1. Firebase Auth is used for authentication
2. User profile is created in `users/{userId}` on first login
3. User has no club access until claim or invite

## Tasks / Subtasks

- [x] Task 1: Create Auth trigger Cloud Function (AC: 2)
  - [x] 1.1 Create `functions/src/auth/onUserCreate.ts` module
  - [x] 1.2 Implement `auth.user().onCreate()` trigger
  - [x] 1.3 Create `users/{userId}` document with schema fields
  - [x] 1.4 Initialize `clubMemberships` as empty array (AC: 3)
  - [x] 1.5 Export function from `functions/src/index.ts`

- [x] Task 2: Write unit tests for onUserCreate (AC: 1, 2, 3)
  - [x] 2.1 Set up Firebase emulator test environment
  - [x] 2.2 Test: User doc created with correct schema on auth signup
  - [x] 2.3 Test: clubMemberships initialized as empty array
  - [x] 2.4 Test: Idempotent behavior (no error if doc exists)

- [x] Task 3: Validate security rules for users collection (AC: 1)
  - [x] 3.1 Test: Authenticated user can read any user doc
  - [x] 3.2 Test: User can create own doc (uid match)
  - [x] 3.3 Test: User can update own doc
  - [x] 3.4 Test: User cannot delete any user doc
  - [x] 3.5 Test: Unauthenticated access denied

- [x] Task 4: Create emulator seed script for testing
  - [x] 4.1 Add test user creation to seed script
  - [x] 4.2 Document manual testing steps

## Dev Notes

### User Document Schema
[Source: Firebase implementation plan.md §1.1]

```typescript
// users/{userId}
interface UserDocument {
  uid: string;                    // Firebase Auth UID
  email: string;
  displayName: string;
  photoURL: string | null;
  createdAt: Timestamp;
  updatedAt: Timestamp;
  clubMemberships: string[];      // Array of clubIds (initially empty)
}
```

### Auth Configuration
[Source: Firebase implementation plan.md §3.1]

- **Provider:** Email/Password (MVP)
- **Email verification:** Required before club claim (enforced in Sprint 1, not this story)
- **Session:** Firebase Auth tokens (1 hour, auto-refresh)

### Security Rules (Already Deployed)
[Source: firestore.rules]

```javascript
match /users/{userId} {
  allow read: if isAuthenticated();
  allow create: if isAuthenticated() && request.auth.uid == userId;
  allow update: if request.auth.uid == userId || isPlatformAdmin();
  allow delete: if false;  // Never delete users
}
```

**Note:** Rules allow client-side creation, but we use a Cloud Function trigger to guarantee user doc exists and centralize logic.

### Cloud Function Pattern
[Source: Firebase implementation plan.md §2.1]

Auth triggers use `functions.auth.user().onCreate()`. The function should:
1. Extract user info from `UserRecord` parameter
2. Create Firestore doc at `users/{user.uid}`
3. Handle errors gracefully (log, don't throw)

### File Locations

| File | Purpose |
|------|---------|
| `functions/src/auth/onUserCreate.ts` | Auth trigger implementation |
| `functions/src/index.ts` | Export the trigger |
| `functions/src/__tests__/auth/onUserCreate.test.ts` | Unit tests |

### Architecture Constraints
[Source: Code Execution Brief §1]

- Cloud Functions own state transitions
- This function creates initial user state
- No derived data stored (clubMemberships is actual data, not derived)

## Testing

### Test Framework
- Firebase Emulator Suite for integration tests
- Jest for unit tests (if applicable)

### Test Location
`functions/src/__tests__/auth/`

### Required Tests
1. **Happy path:** New auth user triggers doc creation
2. **Schema validation:** All required fields present with correct types
3. **Empty memberships:** clubMemberships is empty array, not null/undefined
4. **Idempotency:** Function handles existing doc gracefully (no overwrite)
5. **Security rules:** Verify rules work as documented

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-05 | 1.0 | Initial draft | SM Agent (Bob) |
| 2025-01-05 | 1.1 | Implementation complete, all tasks done | Dev Agent (James) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
- Fixed ESLint error: Added `scripts` to tsconfig.json include array
- Fixed Jest timeout: Rewrote tests with mocks instead of emulator dependency
- Fixed firebase-functions-test import: Changed to default import
- Fixed UserRecord type: Used `any` type for mocks
- Fixed Timestamp.now() undefined: Added to firebase-admin mock
- Fixed jest.config.js ESLint error: Added to ignorePatterns

### Completion Notes List
- Auth trigger creates user doc on Firebase Auth signup
- Unit tests run offline with mocks (no emulator required)
- Security rules tests require emulator (`npm run test:emulator`)
- Seed script creates 3 test users for manual testing

### File List
| File | Action | Purpose |
|------|--------|---------|
| `functions/src/auth/onUserCreate.ts` | Created | Auth trigger Cloud Function |
| `functions/src/index.ts` | Modified | Added auth trigger export |
| `functions/src/__tests__/auth/onUserCreate.test.ts` | Created | Unit tests with mocks |
| `functions/src/__tests__/rules/users.rules.test.ts` | Created | Security rules tests |
| `functions/scripts/seed-test-users.ts` | Created | Emulator seed script |
| `functions/jest.config.js` | Created | Jest configuration |
| `functions/package.json` | Modified | Added test deps and scripts |
| `functions/tsconfig.json` | Modified | Added scripts to include |
| `functions/.eslintrc.js` | Modified | Added ignorePatterns |

---

## QA Results

### Review Date: 2025-01-05

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall: Excellent** - Clean, well-documented implementation following Firebase best practices.

Strengths:
- Proper TypeScript interfaces for type safety
- Idempotency check prevents duplicate doc creation
- Graceful error handling (logs without throwing, doesn't block auth)
- Clear separation between unit tests (mocked) and integration tests (emulator)
- Comprehensive seed script with safety guards

### Refactoring Performed

None required - code quality is production-ready.

### Compliance Check

- Coding Standards: ✓ ESLint passes, proper TypeScript usage
- Project Structure: ✓ Files in correct locations per story spec
- Testing Strategy: ✓ Unit tests with mocks + security rules tests
- All ACs Met: ✓ All 3 acceptance criteria fully implemented and tested

### Requirements Traceability

| AC# | Requirement | Test Coverage | Status |
|-----|-------------|---------------|--------|
| 1 | Firebase Auth is used | `onUserCreate` trigger implementation | ✓ |
| 2 | User profile created at `users/{userId}` | Unit test: schema creation | ✓ |
| 3 | No club access until claim/invite | Unit test: empty clubMemberships | ✓ |

### Improvements Checklist

- [x] All acceptance criteria implemented
- [x] Unit tests cover happy path and edge cases
- [x] Security rules tests validate access control
- [x] Seed script provides manual testing capability
- [x] Idempotency handled correctly
- [ ] Consider adding error retry logic for transient Firestore failures (future enhancement)

### Security Review

✓ **No concerns** - Auth trigger runs server-side only. No client-exposed endpoints. User data protected by Firestore security rules which deny unauthenticated access.

### Performance Considerations

✓ **No concerns** - Single Firestore write operation. Idempotency check adds minimal overhead (one read before conditional write).

### Files Modified During Review

None - no refactoring required.

### Gate Status

**Gate: PASS** → docs/qa/gates/1.1-user-authentication.yml

### Recommended Status

✓ **Ready for Done** - All acceptance criteria met, comprehensive test coverage, no blocking issues.
