# Story 4.1: Upload Draft Roster (CSV)

## Status
Done

## Story
**As a** club official,
**I want** to upload a roster CSV,
**So that** boxers are created in bulk.

## Acceptance Criteria
1. CSV uploaded to Cloud Storage
2. Boxer records created with `dataStatus=draft`
3. No boxer becomes active automatically

## Tasks / Subtasks

- [x] Task 1: Create Boxer TypeScript interfaces (AC: 2)
  - [x] 1.1 Create `functions/src/types/boxer.ts`
  - [x] 1.2 Define `BoxerDataStatus` type: `'draft' | 'active' | 'archived'`
  - [x] 1.3 Define `BoxerAvailability` type: `'available' | 'unavailable' | 'injured'`
  - [x] 1.4 Define `BoxerGender` type: `'male' | 'female'`
  - [x] 1.5 Define `Boxer` interface matching Firebase implementation plan §1.2.2
  - [x] 1.6 Define `RosterImportStatus` type: `'pending' | 'processing' | 'completed' | 'failed'`
  - [x] 1.7 Define `RosterImportError` interface: `{ row: number, message: string }`
  - [x] 1.8 Define `RosterImport` interface matching Firebase implementation plan §1.2.3

- [x] Task 2: Create processRosterUpload Cloud Function (AC: 1, 2, 3)
  - [x] 2.1 Create `functions/src/roster/processRosterUpload.ts`
  - [x] 2.2 Implement Storage trigger on `clubs/{clubId}/rosters/{fileName}`
  - [x] 2.3 Update rosterImport document status to `'processing'`
  - [x] 2.4 Download and parse CSV file from Cloud Storage
  - [x] 2.5 Validate CSV headers match expected columns
  - [x] 2.6 For each valid row, create boxer document with `dataStatus: 'draft'`
  - [x] 2.7 Generate globally unique `boxerId` for each boxer (e.g., UUID)
  - [x] 2.8 Collect row-level errors (missing required fields, invalid data types)
  - [x] 2.9 Update rosterImport document with final status, boxersCreated count, and errors array
  - [x] 2.10 Write audit log entry for roster import
  - [x] 2.11 Export function from `functions/src/index.ts`

- [x] Task 3: Create initiateRosterUpload callable function (AC: 1)
  - [x] 3.1 Create `functions/src/roster/initiateRosterUpload.ts`
  - [x] 3.2 Verify caller is authenticated and is club member
  - [x] 3.3 Create rosterImport document with status `'pending'`
  - [x] 3.4 Return storagePath for client to upload CSV
  - [x] 3.5 Export function from `functions/src/index.ts`

- [x] Task 4: Write unit tests for processRosterUpload (AC: 1, 2, 3)
  - [x] 4.1 Test: Valid CSV creates boxers with dataStatus='draft'
  - [x] 4.2 Test: All boxers have unique boxerId
  - [x] 4.3 Test: rosterImport status transitions to 'completed' on success
  - [x] 4.4 Test: rosterImport.boxersCreated count matches created boxers
  - [x] 4.5 Test: Invalid rows collected in errors array (import continues)
  - [x] 4.6 Test: Empty CSV results in status='completed' with boxersCreated=0
  - [x] 4.7 Test: Malformed CSV results in status='failed'
  - [x] 4.8 Test: Audit log written on successful import

- [x] Task 5: Write unit tests for initiateRosterUpload (AC: 1)
  - [x] 5.1 Test: Unauthenticated user cannot initiate upload
  - [x] 5.2 Test: User not in club cannot initiate upload
  - [x] 5.3 Test: Club member can initiate upload
  - [x] 5.4 Test: Returns valid storagePath for club
  - [x] 5.5 Test: Creates rosterImport document with status='pending'

## Dev Notes

### Previous Story Insights
[Source: Story 3.2 Dev Notes]
- Callable function pattern established in `searchClubs.ts`
- Types go in `functions/src/types/` directory
- Test patterns established in `functions/src/__tests__/`
- Currently 90 tests passing
- ClubMember pattern shows subcollection document creation

### Data Models

#### Boxer Document
[Source: Firebase implementation plan.md §1.2.2]

```typescript
// clubs/{clubId}/boxers/{boxerId}
interface Boxer {
  boxerId: string;               // Globally unique
  firstName: string;
  lastName: string;
  dob: Timestamp;                // Age NEVER stored, always derived
  gender: 'male' | 'female';
  category: string;              // e.g., 'junior', 'youth', 'elite'
  declaredWeight: number;        // kg
  declaredBouts: number;
  declaredWins: number;
  declaredLosses: number;
  dataStatus: 'draft' | 'active' | 'archived';
  availability: 'available' | 'unavailable' | 'injured';
  notes: string | null;          // Club-only notes
  createdAt: Timestamp;
  updatedAt: Timestamp;
  createdBy: string;             // userId
  lastModifiedBy: string;        // userId
}
```

**Invariants:**
- Boxers belong to exactly one club
- boxerId is globally unique
- Age is NEVER stored (derived from DOB + show date)

#### Roster Import Document
[Source: Firebase implementation plan.md §1.2.3]

```typescript
// clubs/{clubId}/rosterImports/{importId}
interface RosterImport {
  importId: string;
  fileName: string;
  storagePath: string;           // Cloud Storage reference
  status: 'pending' | 'processing' | 'completed' | 'failed';
  boxersCreated: number;
  errors: Array<{ row: number, message: string }>;
  uploadedBy: string;            // userId
  uploadedAt: Timestamp;
  processedAt: Timestamp | null;
}
```

### CSV Format Requirements
Expected CSV columns (header row required):
- `firstName` (required)
- `lastName` (required)
- `dob` (required, format: YYYY-MM-DD)
- `gender` (required: 'male' or 'female')
- `category` (required: e.g., 'junior', 'youth', 'elite')
- `declaredWeight` (required, number in kg)
- `declaredBouts` (optional, defaults to 0)
- `declaredWins` (optional, defaults to 0)
- `declaredLosses` (optional, defaults to 0)
- `availability` (optional, defaults to 'available')
- `notes` (optional)

### Cloud Function Patterns
[Source: Firebase implementation plan.md §2.1]

| Function | Trigger | Responsibility | Writes To |
|----------|---------|----------------|-----------|
| processRosterUpload | Storage Trigger | Parse CSV, create draft boxers | boxers, rosterImports, auditLogs |

State Transition:
```
(CSV upload) ──[processRosterUpload]──► draft
```

### Storage Rules (Already Implemented)
[Source: storage.rules]

```
match /clubs/{clubId}/rosters/{fileName} {
  allow read: if isClubMember(clubId);
  allow write: if isClubMember(clubId) &&
               request.resource.size < 5 * 1024 * 1024 &&  // 5MB limit
               request.resource.contentType.matches('text/csv');
}
```

### Security Rules for Boxers
[Source: Firebase implementation plan.md §4.2]

```
match /boxers/{boxerId} {
  allow read: if isAnyClubMember();    // Cross-club discovery
  allow create: if isClubMember(clubId);
  allow update: if isClubMember(clubId) &&
                  request.resource.data.boxerId == resource.data.boxerId;  // boxerId immutable
  allow delete: if false;  // Archive, never delete
}
```

### Security Rules for Roster Imports
[Source: Firebase implementation plan.md §4.2]

```
match /rosterImports/{importId} {
  allow read: if isClubMember(clubId);
  allow create: if isClubMember(clubId);
  allow update: if false;  // Cloud Functions only
  allow delete: if false;
}
```

### File Locations
[Source: Project structure]
- New types: `functions/src/types/boxer.ts`
- New functions: `functions/src/roster/processRosterUpload.ts`, `functions/src/roster/initiateRosterUpload.ts`
- Tests: `functions/src/__tests__/roster/processRosterUpload.test.ts`, `functions/src/__tests__/roster/initiateRosterUpload.test.ts`
- Update: `functions/src/index.ts` (export new functions)

### Audit Log Pattern
[Source: Firebase implementation plan.md §1.8]

```typescript
// Action for roster import
action: 'roster.import.completed'
targetType: 'club'
targetId: clubId
details: { importId, boxersCreated, errors: errors.length }
```

### Technical Constraints
- Storage trigger (not callable) for processRosterUpload
- Callable function for initiateRosterUpload (creates pending import record)
- CSV parsing library needed (e.g., `csv-parse` or `papaparse`)
- UUID generation for boxerId (e.g., `uuid` package)
- All boxers created with `dataStatus: 'draft'` — never 'active'
- Import is resilient: invalid rows are skipped and logged, valid rows are processed

## Testing

### Test File Locations
- `functions/src/__tests__/roster/processRosterUpload.test.ts`
- `functions/src/__tests__/roster/initiateRosterUpload.test.ts`

### Testing Patterns
[Source: Existing test patterns]
- Use Firebase emulator suite for Storage and Firestore
- Test Storage triggers using emulator's storage bucket
- Test callable functions with authenticated/unauthenticated contexts
- Follow patterns from `claimClub.test.ts` and `searchClubs.test.ts`

### Coverage Requirements
- All acceptance criteria must have corresponding tests
- Test both success and failure paths
- Test edge cases: empty CSV, malformed CSV, partial failures

## File List
- `functions/src/types/boxer.ts` (new) - Boxer and RosterImport TypeScript interfaces
- `functions/src/roster/processRosterUpload.ts` (new) - Storage trigger for CSV processing
- `functions/src/roster/initiateRosterUpload.ts` (new) - Callable function to initiate upload
- `functions/src/index.ts` (modified) - Export new functions
- `functions/src/__tests__/roster/processRosterUpload.test.ts` (new) - 13 tests
- `functions/src/__tests__/roster/initiateRosterUpload.test.ts` (new) - 14 tests
- `functions/package.json` (modified) - Added csv-parse, uuid, @types/uuid dependencies

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Implementation Notes
1. **Types file** (`boxer.ts`): Created comprehensive TypeScript interfaces for Boxer, RosterImport, and related types matching Firebase implementation plan.

2. **processRosterUpload** (Storage trigger):
   - Triggers on `clubs/{clubId}/rosters/{fileName}` path
   - Parses CSV twice: first to extract headers (handles empty CSVs), then with columns option
   - Uses batched writes (500 per batch) for large imports
   - Resilient processing: invalid rows logged as errors, valid rows processed
   - Writes audit log on completion

3. **initiateRosterUpload** (Callable function):
   - Validates authentication and club membership
   - Verifies club exists and is claimed
   - Creates rosterImport document with status='pending'
   - Returns storagePath using `{importId}.csv` pattern per QA recommendation

4. **Dependencies added**: csv-parse, uuid, @types/uuid

### Deviations
1. **Empty CSV handling**: Modified CSV parsing logic to handle CSVs with only headers (no data rows). Original implementation would fail header validation for empty CSVs. Now properly completes with boxersCreated=0.

### Completion Notes
- All 5 tasks completed
- 27 new tests added (13 for processRosterUpload, 14 for initiateRosterUpload)
- Total test count: 117 (up from 90)
- All tests passing
- Lint passing


## QA Results

### Pre-Implementation Review: 2026-01-06

**Reviewed By:** Quinn (Test Architect)

### Requirements Traceability

| AC | Tasks | Tests | Status |
|----|-------|-------|--------|
| 1 - CSV uploaded to Cloud Storage | Task 2.2, Task 3.3-3.4 | 5.3, 5.4 | PASS |
| 2 - Boxer records created with dataStatus=draft | Task 1.5, Task 2.6 | 4.1 | PASS |
| 3 - No boxer becomes active automatically | Implicit (all draft) | 4.1 | PASS |

All acceptance criteria are testable and have corresponding tasks and tests.

### Technical Approach Assessment

| Area | Status | Notes |
|------|--------|-------|
| Data Models | PASS | Boxer and RosterImport interfaces well-defined |
| Security Rules | PASS | Already implemented in firestore.rules (lines 54-68) |
| Storage Rules | PASS | Already implemented in storage.rules |
| Function Pattern | PASS | Storage trigger + callable pattern appropriate |
| Audit Logging | PASS | Established pattern exists in approveClubClaim.ts |

### Risk Assessment

| Risk | Probability | Impact | Score | Mitigation |
|------|-------------|--------|-------|------------|
| Large CSV exceeds batch limits | Medium | Medium | 4 | Dev should use batched writes (500 per batch) |
| Partial import failure | Low | Medium | 3 | Story specifies resilient import (skip bad rows) |
| Duplicate boxerId collision | Very Low | High | 2 | UUID v4 has negligible collision risk |

**Overall Risk: LOW** — No blocking risks identified.

### Technical Clarifications Needed

The following items should be addressed during implementation:

1. **clubId Extraction**: processRosterUpload must extract clubId from the storage path pattern `clubs/{clubId}/rosters/{fileName}`. This is straightforward but not explicitly documented.

2. **rosterImport Linkage**: The Storage trigger needs to locate the corresponding rosterImport document. Options:
   - Match by fileName within the club's rosterImports subcollection
   - Include importId in the fileName (recommended: `{importId}.csv`)

3. **Batch Write Strategy**: For large CSVs, use Firestore batched writes (max 500 operations per batch). This ensures atomicity within batches and handles the 5MB/~1000+ row potential.

### NFR Validation (Pre-Implementation)

| Attribute | Status | Notes |
|-----------|--------|-------|
| Security | PASS | Auth checks in callable; Cloud Function has admin access |
| Performance | PASS | Storage trigger is async; no blocking concerns |
| Reliability | PASS | Error collection allows partial success |
| Maintainability | PASS | Types and patterns well-documented |

### Gate Status

**Gate: PASS** — Ready for implementation

### Recommendations

**Immediate (for Dev):**
1. Use `{importId}.csv` as fileName pattern for reliable rosterImport linkage
2. Implement batched writes for boxer creation (500 per batch)
3. Copy `writeAuditLog` helper pattern from `approveClubClaim.ts`

**Future (non-blocking):**
- Consider adding import progress tracking for very large files

---

### Post-Implementation Review: 2026-01-07

**Reviewed By:** Quinn (Test Architect)

### Code Quality Assessment

**Overall: EXCELLENT** — Implementation is clean, well-documented, and follows established patterns.

**Strengths:**
- Comprehensive TypeScript interfaces with clear documentation
- Proper separation of concerns (types, functions, tests)
- Resilient error handling with row-level error collection
- Batched writes for large imports (500 per batch)
- Consistent use of audit logging pattern

**Code Metrics:**
- Implementation: 738 lines (types + functions)
- Tests: 807 lines
- Test-to-code ratio: 1.09:1 (excellent)

### Requirements Traceability (Post-Implementation)

| AC | Implementation | Tests | Given-When-Then |
|----|----------------|-------|-----------------|
| 1 | Storage trigger on `clubs/{clubId}/rosters/{fileName}` | 3 path matching tests, 5 upload flow tests | **Given** a club member initiates upload, **When** CSV is uploaded to Storage, **Then** trigger processes file |
| 2 | All boxers created with `dataStatus: 'draft'` | Tests 4.1, 4.2 verify dataStatus | **Given** valid CSV row, **When** boxer is created, **Then** dataStatus = 'draft' |
| 3 | No activation logic exists | Implicit via AC 2 tests | **Given** any import, **When** complete, **Then** no boxer has dataStatus = 'active' |

**Coverage: 100%** — All acceptance criteria fully covered by tests.

### Compliance Check

- Coding Standards: ✓ Lint passes, consistent formatting
- Project Structure: ✓ Files in correct directories (`types/`, `roster/`, `__tests__/roster/`)
- Testing Strategy: ✓ Unit tests with mocks, no emulator dependency
- All ACs Met: ✓ All 3 acceptance criteria implemented and tested

### Pre-Implementation Recommendations Addressed

| Recommendation | Status |
|----------------|--------|
| Use `{importId}.csv` filename pattern | ✓ Implemented in initiateRosterUpload.ts:93 |
| Implement batched writes (500 per batch) | ✓ Implemented in processRosterUpload.ts:405-423 |
| Copy writeAuditLog pattern | ✓ Implemented in processRosterUpload.ts:44-61 |

### Security Review

**Status: PASS**

- Authentication required for initiateRosterUpload ✓
- Club membership verified before upload ✓
- Club must be claimed before upload ✓
- Storage rules enforce member-only access ✓
- No PII exposed in logs ✓

### Performance Considerations

**Status: PASS**

- Async Storage trigger — no blocking
- Batched writes for large imports
- CSV parsed in memory (acceptable for 5MB limit)
- No N+1 query patterns

### Test Architecture Assessment

**Status: PASS**

| Aspect | Assessment |
|--------|------------|
| Coverage | 27 tests covering all paths |
| Mock strategy | Appropriate mocking of Firebase Admin SDK |
| Edge cases | Empty CSV, malformed CSV, missing headers, invalid rows |
| Error scenarios | Unauthenticated, non-member, unclaimed club |

### Improvements Checklist

- [x] All pre-implementation recommendations addressed
- [x] Comprehensive error handling
- [x] Audit logging implemented
- [x] Batched writes for scalability
- [ ] Future: Consider progress tracking for very large files
- [ ] Future: Consider retry logic for transient failures

### Files Modified During Review

None — No refactoring required. Implementation is production-ready.

### Gate Status

**Gate: PASS**

- Quality Score: 100/100
- All ACs verified
- All tests passing (117 total)
- No security concerns
- No performance concerns

→ Gate file: `docs/qa/gates/4.1-upload-draft-roster.yml`

### Recommended Status

**✓ Ready for Done**

The implementation fully meets all acceptance criteria, follows established patterns, and includes comprehensive test coverage. Story is ready to be marked as Done.

---

## Change Log
| Date | Author | Change |
|------|--------|--------|
| 2026-01-07 | Quinn (QA) | Status set to Done |
| 2026-01-07 | Quinn (QA) | Post-implementation review: PASS - Ready for Done |
| 2026-01-06 | James (Dev) | Implementation complete, status set to Review |
| 2026-01-06 | James (Dev) | All 5 tasks completed, 117 tests passing |
| 2026-01-06 | Quinn (QA) | Story approved, handed to Dev |
| 2026-01-06 | Quinn (QA) | Pre-implementation review: PASS |
| 2026-01-06 | Bob (SM) | Initial draft |
