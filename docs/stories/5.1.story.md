# Story 5.1: Browse Other Clubs' Boxers

## Status
Done

## Story
**As a** club official,
**I want** to view boxers from other clubs,
**So that** I can find opponents for matchmaking.

## Acceptance Criteria
1. Only authenticated club members can access boxer profiles
2. Boxer name, DOB, age (derived), and declared record are visible
3. Boxer profiles are never publicly accessible
4. Notes field is excluded (club-private data)

## Tasks / Subtasks

- [x] Task 1: Create searchBoxers callable function (AC: 1, 2, 3, 4)
  - [x] 1.1 Create `functions/src/discovery/searchBoxers.ts`
  - [x] 1.2 Verify caller is authenticated
  - [x] 1.3 Verify caller is a member of at least one club
  - [x] 1.4 Accept filter parameters (gender, category, weightMin, weightMax, availability)
  - [x] 1.5 Query boxers across all clubs with filters
  - [x] 1.6 Exclude caller's own club boxers (optional flag)
  - [x] 1.7 Only return active boxers (dataStatus: 'active')
  - [x] 1.8 Compute age from DOB (never store)
  - [x] 1.9 Exclude notes field from response
  - [x] 1.10 Include club name in response
  - [x] 1.11 Implement pagination (limit/offset)
  - [x] 1.12 Export function from `functions/src/index.ts`

- [x] Task 2: Add request/response types (AC: 1, 2, 3, 4)
  - [x] 2.1 Create `functions/src/types/discovery.ts`
  - [x] 2.2 Add `SearchBoxersRequest` interface
  - [x] 2.3 Add `SearchBoxersResponse` interface
  - [x] 2.4 Add `BoxerSearchResult` interface (public-safe boxer data)

- [x] Task 3: Write unit tests for searchBoxers (AC: 1, 2, 3, 4)
  - [x] 3.1 Test: Unauthenticated user cannot search boxers
  - [x] 3.2 Test: User not in any club cannot search boxers
  - [x] 3.3 Test: Valid request returns boxers from other clubs
  - [x] 3.4 Test: Filter by gender returns only matching boxers
  - [x] 3.5 Test: Filter by category returns only matching boxers
  - [x] 3.6 Test: Filter by weight range returns only matching boxers
  - [x] 3.7 Test: Filter by availability returns only matching boxers
  - [x] 3.8 Test: Only active boxers are returned (no draft/archived)
  - [x] 3.9 Test: Notes field is never included in response
  - [x] 3.10 Test: Age is computed correctly from DOB
  - [x] 3.11 Test: Club name is included in response
  - [x] 3.12 Test: Own club boxers excluded when flag is true
  - [x] 3.13 Test: Own club boxers included when flag is false
  - [x] 3.14 Test: Pagination works correctly (limit/offset)
  - [x] 3.15 Test: Empty results return empty array (not error)
  - [x] 3.16 Test: Multiple filters combine correctly (AND logic)
  - [x] 3.17 Test: User in multiple clubs - all excluded when flag true
  - [x] 3.18 Test: Invalid weight range (negative) returns error
  - [x] 3.19 Test: Limit exceeds max (>100) capped to 100

## Dev Notes

### Previous Story Insights
[Source: Story 4.3]
- Boxer types defined in `functions/src/types/boxer.ts`
- Test count: 162 tests passing
- Callable function patterns established in roster functions

### Architecture Context
[Source: Architecture v1 §3, Firebase Implementation Plan §4.2]

**Security Rules (Already Implemented):**
```
match /boxers/{boxerId} {
  allow read: if isAnyClubMember();  // Cross-club discovery
}
```

**Key Constraints:**
- Age is NEVER stored — derive from DOB at query time
- Notes field is club-private — never expose to other clubs
- Compliance filtering happens at runtime, not stored
- No `isEligible` or similar flags stored

### Data Model

#### Boxer Document (Source)
[Source: Firebase implementation plan.md §1.2.2]

```typescript
// clubs/{clubId}/boxers/{boxerId}
interface Boxer {
  boxerId: string;               // Globally unique
  firstName: string;
  lastName: string;
  dob: Timestamp;                // Age derived, never stored
  gender: 'male' | 'female';
  category: string;              // e.g., 'junior', 'youth', 'elite'
  declaredWeight: number;        // kg
  declaredBouts: number;
  declaredWins: number;
  declaredLosses: number;
  dataStatus: 'draft' | 'active' | 'archived';
  availability: 'available' | 'unavailable' | 'injured';
  notes: string | null;          // CLUB-PRIVATE - never expose
  createdAt: Timestamp;
  updatedAt: Timestamp;
  createdBy: string;
  lastModifiedBy: string;
}
```

#### BoxerSearchResult (Response)
```typescript
interface BoxerSearchResult {
  boxerId: string;
  firstName: string;
  lastName: string;
  dob: Timestamp;
  age: number;                   // DERIVED at query time
  gender: 'male' | 'female';
  category: string;
  declaredWeight: number;
  declaredBouts: number;
  declaredWins: number;
  declaredLosses: number;
  availability: 'available' | 'unavailable' | 'injured';
  clubId: string;
  clubName: string;              // Denormalized for display
}
// NOTE: No notes, createdAt, updatedAt, createdBy, lastModifiedBy
```

### Request/Response Types

```typescript
interface SearchBoxersRequest {
  // Filters (all optional)
  gender?: 'male' | 'female';
  category?: string;
  weightMin?: number;
  weightMax?: number;
  availability?: 'available' | 'unavailable' | 'injured';
  excludeOwnClub?: boolean;      // Default: true

  // Pagination
  limit?: number;                // Default: 20, max: 100
  offset?: number;               // Default: 0
}

interface SearchBoxersResponse {
  success: boolean;
  boxers: BoxerSearchResult[];
  total: number;                 // Total matching (for pagination)
  hasMore: boolean;
}
```

### Query Strategy

**Firestore Limitations:**
- Cannot query across subcollections directly
- Must use Collection Group Query on `boxers`

**Implementation Approach:**
1. Use `collectionGroup('boxers')` to query all boxer subcollections
2. Apply filters using Firestore `.where()` clauses
3. Filter out caller's own club in-memory (if excludeOwnClub is true)
4. Compute age from DOB in response mapping
5. Fetch club names via batch read or denormalize

**Index Requirements:**
- Collection group index on `boxers` for: `dataStatus`, `gender`, `category`, `availability`
- Composite indexes may be needed for multi-field queries

### Age Calculation
```typescript
function calculateAge(dob: Timestamp): number {
  const today = new Date();
  const birthDate = dob.toDate();
  let age = today.getFullYear() - birthDate.getFullYear();
  const monthDiff = today.getMonth() - birthDate.getMonth();
  if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
    age--;
  }
  return age;
}
```

### Edge Cases
1. **No filters provided**: Return all active boxers (paginated)
2. **No matching boxers**: Return empty array, not error
3. **User in multiple clubs**: Exclude all their clubs when flag is true
4. **Weight range edge**: Inclusive bounds (weightMin <= weight <= weightMax)

## Testing

### Test File Location
- `functions/src/__tests__/discovery/searchBoxers.test.ts`

### Testing Patterns
[Source: Existing test patterns]
- Mock Firebase Admin SDK (Firestore, Auth)
- Test authentication and authorization separately
- Test each filter independently
- Test filter combinations
- Follow patterns from `updateBoxer.test.ts`

### Coverage Requirements
- All acceptance criteria must have corresponding tests
- Test each filter in isolation and combination
- Verify notes field exclusion
- Verify age computation accuracy

## File List
- `functions/src/discovery/searchBoxers.ts` (new) - Callable function
- `functions/src/types/discovery.ts` (new) - Request/response types
- `functions/src/index.ts` (modified) - Export new function
- `functions/src/__tests__/discovery/searchBoxers.test.ts` (new) - Unit tests

## QA Checklist (Pre-Implementation)
- [x] Requirements are testable
- [x] All AC mapped to tasks and tests
- [x] Data model aligns with architecture
- [x] Security constraints addressed
- [x] Edge cases identified

---

## Change Log
| Date | Author | Change |
|------|--------|--------|
| 2026-01-07 | James (Dev) | Implementation complete: searchBoxers function, types, 24 tests (186 total passing) |
| 2026-01-07 | Quinn (QA) | Pre-implementation review: PASS, added tests 3.17-3.19 |
| 2026-01-07 | John (PM) | Initial draft |

## QA Results

### Pre-Implementation Review: 2026-01-07

**Reviewed By:** Quinn (Test Architect)

### Requirements Traceability

| AC | Tasks | Tests | Status |
|----|-------|-------|--------|
| 1 - Only authenticated club members | Task 1.2, 1.3 | 3.1, 3.2 | PASS |
| 2 - Name, DOB, age, record visible | Task 1.8, 1.10 | 3.10, 3.11 | PASS |
| 3 - Never publicly accessible | Task 1.2, 1.3 | 3.1, 3.2 | PASS |
| 4 - Notes field excluded | Task 1.9 | 3.9 | PASS |

All acceptance criteria are testable and have corresponding tasks and tests.

### Technical Approach Assessment

| Area | Status | Notes |
|------|--------|-------|
| Data Models | PASS | Aligns with Boxer interface, adds BoxerSearchResult |
| Security | PASS | Auth + club membership validation, notes excluded |
| Function Pattern | PASS | HTTPS Callable follows established pattern |
| Query Strategy | PASS | Collection group query appropriate |
| Pagination | PASS | limit/offset with max cap |
| Age Derivation | PASS | Computed at runtime per architecture |

### Risk Assessment

| Risk | Probability | Impact | Score | Mitigation |
|------|-------------|--------|-------|------------|
| Performance (large result sets) | Medium | Medium | 4 | Pagination + max limit of 100 |
| Index requirements | Low | Medium | 2 | Document required indexes |
| Club name lookup overhead | Low | Low | 1 | Batch read or denormalize |

**Overall Risk: LOW** — Read-only query operation with established patterns.

### Test Coverage Assessment

| Category | Count | Status |
|----------|-------|--------|
| Auth/authz tests | 2 | PASS |
| Success path tests | 1 | PASS |
| Filter tests | 5 | PASS |
| Edge case tests | 5 | PASS |
| Pagination tests | 1 | PASS |
| Multi-filter tests | 1 | PASS |
| **Subtotal** | **16** | - |

### Gaps Identified

Added 3 additional test cases during review:

| Test ID | Description | Rationale |
|---------|-------------|-----------|
| 3.17 | User in multiple clubs - all excluded when flag true | Edge case explicitly mentioned but not tested |
| 3.18 | Invalid weight range (negative) returns error | Input validation |
| 3.19 | Limit exceeds max (>100) capped to 100 | Pagination boundary |

**Updated Total: 19 tests planned**

### NFR Validation (Pre-Implementation)

| Attribute | Status | Notes |
|-----------|--------|-------|
| Security | PASS | Auth required, notes excluded, security rules exist |
| Performance | PASS | Pagination, max limit, indexed queries |
| Reliability | PASS | Simple read operation |
| Maintainability | PASS | Follows established patterns, types documented |

### Index Requirements Note

The implementation should document required Firestore indexes:
- Collection group index: `boxers` with `dataStatus`, `gender`, `category`, `availability`
- Composite indexes for common filter combinations

### Gate Status

**Gate: PASS** — Ready for implementation

All acceptance criteria are testable, requirements trace to tasks and tests, architecture alignment verified.

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Completion Notes
- Implemented `searchBoxers` callable function with full filter support (gender, category, weight range, availability)
- Age computed at runtime per architecture rules (never stored)
- Notes field excluded from response (club-private data)
- Club names included via batch lookup
- Pagination with limit cap at 100
- 24 new tests added (186 total passing)

### DoD Checklist

1. **Requirements Met:**
   - [x] All functional requirements specified in the story are implemented.
   - [x] All acceptance criteria defined in the story are met.

2. **Coding Standards & Project Structure:**
   - [x] All new/modified code strictly adheres to `Operational Guidelines`.
   - [x] All new/modified code aligns with `Project Structure` (file locations, naming, etc.).
   - [x] Adherence to `Tech Stack` for technologies/versions used.
   - [x] Adherence to `Api Reference` and `Data Models`.
   - [x] Basic security best practices applied (auth check, club membership validation, notes excluded).
   - [x] No new linter errors or warnings introduced.
   - [x] Code is well-commented where necessary.

3. **Testing:**
   - [x] All required unit tests as per the story are implemented (19 test cases, 24 actual tests).
   - [N/A] Integration tests - not specified for this story.
   - [x] All tests pass successfully (186 total).
   - [x] Test coverage meets project standards.

4. **Functionality & Verification:**
   - [x] Functionality verified via unit tests.
   - [x] Edge cases handled (empty results, pagination bounds, multi-club membership, negative weights).

5. **Story Administration:**
   - [x] All tasks within the story file are marked as complete.
   - [x] Clarifications documented in story file.
   - [x] Story wrap up section completed.

6. **Dependencies, Build & Configuration:**
   - [x] Project builds successfully without errors.
   - [x] Project linting passes.
   - [N/A] No new dependencies added.
   - [N/A] No new environment variables introduced.

7. **Documentation:**
   - [x] Inline code documentation complete (TSDoc comments on all functions).
   - [N/A] No user-facing documentation changes needed.
   - [N/A] No architectural changes requiring diagram updates.

### Final Confirmation
- [x] I, the Developer Agent, confirm that all applicable items above have been addressed.

---

## QA Results

### Post-Implementation Review: 2026-01-07

**Reviewed By:** Quinn (Test Architect)

### Code Quality Assessment

**Overall: EXCELLENT** - Clean implementation following established patterns with comprehensive test coverage.

| Area | Rating | Notes |
|------|--------|-------|
| Architecture | ✓ | Follows callable function patterns from previous stories |
| Security | ✓ | Auth + club membership validation; notes properly excluded |
| Error Handling | ✓ | All inputs validated with appropriate HttpsError codes |
| Performance | ✓ | Batch club lookup, pagination with 100 cap, indexed queries |
| Maintainability | ✓ | Well-documented helpers, clear separation of concerns |
| Test Coverage | ✓ | 24 tests covering all 19 planned scenarios + extras |

### Refactoring Performed

None required. Code is clean and well-structured.

### Compliance Check

- Coding Standards: ✓ ESLint passes, consistent patterns
- Project Structure: ✓ Correct file locations (`discovery/`, `types/`, `__tests__/discovery/`)
- Testing Strategy: ✓ Unit tests with mocks, all edge cases covered
- All ACs Met: ✓ See traceability matrix below

### Requirements Traceability (Post-Implementation)

| AC | Implementation | Tests | Verified |
|----|----------------|-------|----------|
| 1 - Only authenticated club members | `searchBoxers.ts:211-229` | 3.1, 3.2 | ✓ |
| 2 - Name, DOB, age, record visible | `toBoxerSearchResult()` | 3.10, 3.11, response structure | ✓ |
| 3 - Never publicly accessible | Auth required at function entry | 3.1, 3.2 | ✓ |
| 4 - Notes field excluded | `toBoxerSearchResult()` excludes notes | 3.9, response structure | ✓ |

### Improvements Checklist

- [x] All acceptance criteria implemented and tested
- [x] Notes field exclusion verified (Test 3.9)
- [x] Age computed at runtime, never stored (Test 3.10)
- [x] Pagination with max limit enforced (Test 3.19)
- [x] Input validation for all parameters
- [x] Multi-club membership handled correctly (Test 3.17)
- [ ] *Future consideration*: Add Firestore composite index documentation to deployment notes

### Security Review

| Check | Status | Notes |
|-------|--------|-------|
| Authentication required | ✓ | `context.auth` checked first |
| Authorization (club membership) | ✓ | `getUserClubIds()` validates membership |
| Data exposure prevention | ✓ | `toBoxerSearchResult()` whitelist approach excludes notes, internal fields |
| Input validation | ✓ | `validateRequest()` validates all parameters |

**No security concerns identified.**

### Performance Considerations

| Aspect | Status | Notes |
|--------|--------|-------|
| Query efficiency | ✓ | Collection group query with Firestore-level filtering |
| Pagination | ✓ | Default 20, max 100 per request |
| Club name lookup | ✓ | Batch `getAll()` instead of N+1 queries |
| Weight filtering | ⚠️ | In-memory (Firestore limitation) - acceptable given pagination |

**No blocking performance concerns.** Weight filtering in-memory is documented and acceptable.

### Files Modified During Review

None - no refactoring required.

### Test Architecture Assessment

| Metric | Value | Assessment |
|--------|-------|------------|
| Total new tests | 24 | Exceeds 19 planned |
| Coverage areas | Auth, filters, pagination, edge cases | Comprehensive |
| Mock quality | Good | Proper Firestore/Functions mocking |
| Edge cases | Covered | Empty results, multi-club, negative weights, limit cap |

### Gate Status

**Gate: PASS** → `docs/qa/gates/5.1-browse-other-clubs-boxers.yml`

### Recommended Status

✓ **Ready for Done** - All acceptance criteria met, comprehensive test coverage, clean implementation.
