# Story 2.2: Claim a Club

## Status
Done

## Story
**As a** club official,
**I want** to claim my club,
**So that** I can manage its data.

## Acceptance Criteria
1. Claim request sets club to `claim_pending`
2. Admin can approve or reject claim
3. On approval, club becomes `claimed`
4. All transitions are audited

## Tasks / Subtasks

- [x] Task 1: Create claimClub callable function (AC: 1, 4)
  - [x] 1.1 Create `functions/src/clubs/claimClub.ts`
  - [x] 1.2 Validate user is authenticated
  - [x] 1.3 Validate club exists and status is `unclaimed`
  - [x] 1.4 Update club: status='claim_pending', claimedBy=userId
  - [x] 1.5 Write audit log entry (action: 'club.claim.requested')
  - [x] 1.6 Export function from `functions/src/index.ts`

- [x] Task 2: Create approveClubClaim callable function (AC: 2, 3, 4)
  - [x] 2.1 Create `functions/src/clubs/approveClubClaim.ts`
  - [x] 2.2 Validate caller is platform admin (isPlatformAdmin claim)
  - [x] 2.3 Validate club exists and status is `claim_pending`
  - [x] 2.4 Update club: status='claimed', claimedAt=now
  - [x] 2.5 Create member document in `clubs/{clubId}/members/{userId}`
  - [x] 2.6 Update user document: add clubId to `clubMemberships` array
  - [x] 2.7 Write audit log entry (action: 'club.claim.approved')
  - [x] 2.8 Export function from `functions/src/index.ts`

- [x] Task 3: Create rejectClubClaim callable function (AC: 2, 4)
  - [x] 3.1 Create `functions/src/clubs/rejectClubClaim.ts`
  - [x] 3.2 Validate caller is platform admin
  - [x] 3.3 Validate club exists and status is `claim_pending`
  - [x] 3.4 Update club: status='unclaimed', claimedBy=null
  - [x] 3.5 Write audit log entry (action: 'club.claim.rejected')
  - [x] 3.6 Export function from `functions/src/index.ts`

- [x] Task 4: Create ClubMember TypeScript interface (AC: 3)
  - [x] 4.1 Create or update `functions/src/types/club.ts` with ClubMember interface
  - [x] 4.2 Include fields: userId, displayName, role, joinedAt, updatedAt

- [x] Task 5: Write unit tests for claimClub (AC: 1, 4)
  - [x] 5.1 Test: Unauthenticated user cannot claim
  - [x] 5.2 Test: Claim on unclaimed club succeeds, sets claim_pending
  - [x] 5.3 Test: Claim on already claimed club fails
  - [x] 5.4 Test: Claim on claim_pending club fails
  - [x] 5.5 Test: Audit log is written

- [x] Task 6: Write unit tests for approveClubClaim (AC: 2, 3, 4)
  - [x] 6.1 Test: Non-admin cannot approve
  - [x] 6.2 Test: Approve sets status to 'claimed'
  - [x] 6.3 Test: Approve creates member document
  - [x] 6.4 Test: Approve updates user's clubMemberships
  - [x] 6.5 Test: Approve on non-pending club fails
  - [x] 6.6 Test: Audit log is written

- [x] Task 7: Write unit tests for rejectClubClaim (AC: 2, 4)
  - [x] 7.1 Test: Non-admin cannot reject
  - [x] 7.2 Test: Reject resets club to 'unclaimed'
  - [x] 7.3 Test: Reject on non-pending club fails
  - [x] 7.4 Test: Audit log is written

- [x] Task 8: Write security rules tests for members subcollection (AC: 3)
  - [x] 8.1 Test: Authenticated user can read club members
  - [x] 8.2 Test: Client cannot write to members subcollection
  - [x] 8.3 Test: Admin cannot write to members via client

## Dev Notes

### Previous Story Context (2.1)
[Source: Story 2.1 Completion Notes]

- Club types already exist in `functions/src/types/club.ts`: Club, ClubStatus, ClubSearchResult
- Security rules for clubs collection already exist in `firestore.rules`
- Existing pattern: callable functions with auth check, audit logging, proper error codes

### Club Lifecycle
[Source: Firebase implementation plan.md §2.2]

```
unclaimed ──[claimClub]──► claim_pending ──[approveClubClaim]──► claimed
                                         ──[rejectClubClaim]──► unclaimed
```

### Club Schema (Existing)
[Source: Firebase implementation plan.md §1.2]

```typescript
// clubs/{clubId}
interface Club {
  clubId: string;
  name: string;
  region: string;
  status: 'unclaimed' | 'claim_pending' | 'claimed' | 'suspended';
  claimedBy: string | null;       // userId who claimed
  claimedAt: Timestamp | null;
  contactEmail: string | null;
  contactPhone: string | null;
  createdAt: Timestamp;
  updatedAt: Timestamp;
}
```

### Club Member Schema (New)
[Source: Firebase implementation plan.md §1.2.1]

```typescript
// clubs/{clubId}/members/{userId}
interface ClubMember {
  userId: string;
  displayName: string;            // Denormalized from user
  role: string;                   // 'coach' | 'matchmaker' | 'secretary' | 'chair' (descriptive only)
  joinedAt: Timestamp;
  updatedAt: Timestamp;
}
```

**Note:** Role is descriptive only at MVP — not enforced in security rules.

### User Document Update
[Source: Firebase implementation plan.md §1.1]

On club approval, update user's `clubMemberships` array:
```typescript
// users/{userId}
{
  clubMemberships: string[]  // Array of clubIds (denormalized for queries)
}
```

### Cloud Function Responsibilities
[Source: Firebase implementation plan.md §2.1]

| Function | Trigger | Writes To |
|----------|---------|-----------|
| claimClub | HTTPS Callable | clubs, auditLogs |
| approveClubClaim | HTTPS Callable | clubs, members, users, auditLogs |
| rejectClubClaim | HTTPS Callable | clubs, auditLogs |

### Audit Log Schema
[Source: Firebase implementation plan.md §1.8]

```typescript
// admin/auditLogs/entries/{logId}
interface AuditLog {
  logId: string;
  action: string;              // 'club.claim.requested', 'club.claim.approved', 'club.claim.rejected'
  actorId: string;             // userId who performed action
  actorType: 'user' | 'admin';
  targetType: string;          // 'club'
  targetId: string;            // clubId
  targetClubId: string | null; // clubId
  details: object;             // Action-specific data
  timestamp: Timestamp;
  ipAddress: string | null;
}
```

### Security Rules (Existing)
[Source: firestore.rules]

```javascript
match /clubs/{clubId} {
  allow read: if isAuthenticated();
  allow create: if false;  // Pre-seeded only
  allow update: if false;  // Cloud Functions only
  allow delete: if false;

  match /members/{memberId} {
    allow read: if isAuthenticated();
    allow write: if false;  // Cloud Functions only
  }
}
```

**Key Constraint:** Club updates and member writes happen ONLY via Cloud Functions, never via client.

### Auth Requirements
[Source: Firebase implementation plan.md §3.3]

| Action | Auth Required | Additional Check |
|--------|---------------|------------------|
| Claim club | Yes | None (any authenticated user) |
| Approve/reject claim | Yes | isPlatformAdmin: true |

### File Locations

| File | Purpose |
|------|---------|
| `functions/src/clubs/claimClub.ts` | Claim callable function |
| `functions/src/clubs/approveClubClaim.ts` | Approve callable function |
| `functions/src/clubs/rejectClubClaim.ts` | Reject callable function |
| `functions/src/types/club.ts` | Add ClubMember interface |
| `functions/src/index.ts` | Export new functions |
| `functions/src/__tests__/clubs/claimClub.test.ts` | Unit tests |
| `functions/src/__tests__/clubs/approveClubClaim.test.ts` | Unit tests |
| `functions/src/__tests__/clubs/rejectClubClaim.test.ts` | Unit tests |
| `functions/src/__tests__/rules/clubs.rules.test.ts` | Add members tests |

## Testing

### Test Framework
- Firebase Emulator Suite for integration tests
- Jest for unit tests

### Test Location
`functions/src/__tests__/clubs/`

### Required Tests
1. **claimClub:** Auth required, unclaimed→claim_pending, audit logged
2. **approveClubClaim:** Admin only, claim_pending→claimed, member created, user updated, audit logged
3. **rejectClubClaim:** Admin only, claim_pending→unclaimed, audit logged
4. **Security rules:** Members subcollection read=auth, write=false

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-05 | 1.0 | Initial draft | SM Agent (Bob) |
| 2026-01-05 | 1.1 | Implementation complete - all tasks done, 79 tests passing | Dev Agent (James) |
| 2026-01-06 | 1.2 | QA gate passed, story signed off as Done | SM Agent (Bob) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
None - implementation completed without blocking issues.

### Completion Notes List
- Implemented full club claim lifecycle: claimClub → approveClubClaim/rejectClubClaim
- All three callable functions follow established patterns from Story 1.2 (setAdminClaim)
- approveClubClaim uses Firestore transaction for atomic multi-document updates (club, member, user)
- Added ClubMember and ClubMemberRole types to functions/src/types/club.ts
- 79 unit tests passing (14 claimClub, 17 approveClubClaim, 15 rejectClubClaim, plus existing tests)
- Security rules for members subcollection already exist in firestore.rules; tests added to clubs.rules.test.ts
- Lint passes with no errors

### File List
| File | Action | Purpose |
|------|--------|---------|
| functions/src/clubs/claimClub.ts | Created | Callable function for users to claim unclaimed clubs |
| functions/src/clubs/approveClubClaim.ts | Created | Admin callable to approve claims, creates member, updates user |
| functions/src/clubs/rejectClubClaim.ts | Created | Admin callable to reject claims, resets club to unclaimed |
| functions/src/types/club.ts | Modified | Added ClubMember interface and ClubMemberRole type |
| functions/src/index.ts | Modified | Export claimClub, approveClubClaim, rejectClubClaim |
| functions/src/__tests__/clubs/claimClub.test.ts | Created | 14 unit tests for claimClub |
| functions/src/__tests__/clubs/approveClubClaim.test.ts | Created | 17 unit tests for approveClubClaim |
| functions/src/__tests__/clubs/rejectClubClaim.test.ts | Created | 15 unit tests for rejectClubClaim |
| functions/src/__tests__/rules/clubs.rules.test.ts | Modified | Added 9 tests for members subcollection rules |

---

## QA Results

### Review Date: 2026-01-05

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall: Excellent** - Implementation is clean, well-structured, and follows established patterns. All three Cloud Functions (claimClub, approveClubClaim, rejectClubClaim) demonstrate consistent coding style with proper:
- Authentication and authorization validation
- Input validation with meaningful error messages
- State precondition checks
- Atomic transactions (approveClubClaim)
- Comprehensive audit logging
- Error handling with appropriate HttpsError codes

### Refactoring Performed

None required - code quality is production-ready.

### Compliance Check

- Coding Standards: ✓ Follows established patterns from Story 1.2 (setAdminClaim)
- Project Structure: ✓ Files in correct locations per architecture
- Testing Strategy: ✓ Unit tests with mocks, security rules tests added
- All ACs Met: ✓ All 4 acceptance criteria fully implemented

### Requirements Traceability

| AC | Requirement | Implementation | Tests |
|----|-------------|----------------|-------|
| AC1 | Claim sets `claim_pending` | claimClub.ts:96-102 | 5.2-5.4 (14 tests) |
| AC2 | Admin approve/reject | approveClubClaim.ts, rejectClubClaim.ts | 6.1, 7.1 (32 tests) |
| AC3 | Approval → `claimed` | approveClubClaim.ts:131-155 (transaction) | 6.2-6.4 |
| AC4 | All transitions audited | writeAuditLog in all 3 functions | 5.5, 6.6, 7.4 |

### Improvements Checklist

- [x] All authentication checks implemented
- [x] All admin authorization checks implemented
- [x] Input validation comprehensive
- [x] State transitions atomic (transaction in approveClubClaim)
- [x] Audit logging complete for all actions
- [x] Types properly defined (ClubMember, ClubMemberRole)
- [x] Tests cover all acceptance criteria
- [ ] Future: Consider extracting shared AuditLogEntry/writeAuditLog to utils (acceptable duplication for now, matches existing pattern)

### Security Review

✓ **PASS** - No security concerns:
- Authentication required for all functions
- Admin authorization via isPlatformAdmin custom claim
- Input validation prevents injection
- State validated before transitions
- No sensitive data exposure in responses
- Audit trail for all actions

### Performance Considerations

✓ **PASS** - No concerns:
- Single document reads/writes
- Transaction scoped to 3 documents max
- No unbounded queries
- Efficient Firestore operations

### Files Modified During Review

None - no refactoring required.

### Gate Status

Gate: **PASS** → docs/qa/gates/2.2-claim-a-club.yml

### Recommended Status

**✓ Ready for Done** - All acceptance criteria met, 79 tests passing, code quality excellent.
