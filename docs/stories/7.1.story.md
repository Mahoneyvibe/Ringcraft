# Story 7.1: Send Bout Proposal

## Status
Draft

## Story
**As a** club official,
**I want** to create a bout proposal for my boxer against a show slot and share it via WhatsApp/SMS deep link,
**So that** I can initiate a structured negotiation with the hosting club to secure a compliant bout.

## Acceptance Criteria
1. Authenticated club member can create a proposal by selecting a boxer from their club and a target show slot
2. Proposal creation captures an immutable boxer snapshot at the time of creation
3. Proposal creation generates a single-use, time-bound, club-bound deep-link token
4. Proposal creation returns a formatted deep-link URL suitable for sharing via WhatsApp or SMS
5. Proposal creation atomically updates the target slot status from `open` to `proposed`
6. Kill switch check prevents proposal creation when `proposalKillSwitch` is enabled
7. Club official can withdraw a pending proposal their club created
8. Withdrawal atomically resets the slot status from `proposed` to `open` and revokes the deep-link token
9. Expired proposals are automatically cleaned up by a scheduled function (hourly)
10. All proposal state transitions (create, withdraw, expire) are audited via append-only audit logs

## Tasks / Subtasks

- [ ] Task 1: Create proposal and deep-link token types (AC: 1, 2, 3)
  - [ ] 1.1 Create `functions/src/types/proposal.ts`
  - [ ] 1.2 Define `Proposal` interface matching Firestore schema (proposalId, fromClubId/Name, toClubId/Name, showId, slotId, showDate, proposedBoxerSnapshot, targetBoxerSnapshot, status, statusReason, respondedAt, respondedBy, deeplinkTokenId, expiresAt, createdAt, createdBy, updatedAt)
  - [ ] 1.3 Define `ProposalStatus` type: `'proposed' | 'accepted' | 'declined' | 'expired' | 'withdrawn' | 'voided'`
  - [ ] 1.4 Define `BoxerSnapshot` interface (boxerId, firstName, lastName, dob, gender, category, declaredWeight, declaredBouts, declaredWins, declaredLosses, clubId, clubName, snapshotAt)
  - [ ] 1.5 Define `CreateProposalRequest` interface (fromBoxerId, showId, slotId)
  - [ ] 1.6 Define `CreateProposalResponse` interface (success, proposalId, deeplinkUrl, shareMessage)
  - [ ] 1.7 Define `WithdrawProposalRequest` interface (proposalId)
  - [ ] 1.8 Define `WithdrawProposalResponse` interface (success)
  - [ ] 1.9 Create `functions/src/types/deeplinkToken.ts`
  - [ ] 1.10 Define `DeeplinkToken` interface (tokenId, proposalId, targetClubId, action, status, consumedAt, expiresAt, createdAt, createdBy)
  - [ ] 1.11 Define `DeeplinkTokenStatus` type: `'active' | 'consumed' | 'expired' | 'revoked'`

- [ ] Task 2: Implement createProposal Cloud Function (AC: 1, 2, 3, 4, 5, 6, 10)
  - [ ] 2.1 Create `functions/src/proposals/createProposal.ts`
  - [ ] 2.2 Verify caller is authenticated
  - [ ] 2.3 Check kill switch via `checkKillSwitch()` (existing helper)
  - [ ] 2.4 Validate request fields (fromBoxerId, showId, slotId)
  - [ ] 2.5 Verify caller is a member of the boxer's club (fromClub)
  - [ ] 2.6 Verify the show exists and is in `published` status
  - [ ] 2.7 Verify the slot exists and is in `open` status
  - [ ] 2.8 Verify the boxer exists, is `active`, and belongs to the caller's club
  - [ ] 2.9 Verify fromClub is not the same as the show's hostClub (cannot propose to own show)
  - [ ] 2.10 Verify the show date is in the future (cannot propose to past shows)
  - [ ] 2.11 Verify the proposed boxer's gender matches the slot's `targetGender`
  - [ ] 2.12 Verify the proposed boxer's category matches the slot's `category`
  - [ ] 2.13 Create immutable `proposedBoxerSnapshot` from current boxer data
  - [ ] 2.14 If slot has `homeBoxerId`, create `targetBoxerSnapshot` from the home boxer data
  - [ ] 2.15 Generate secure random deep-link token (crypto.randomUUID or similar)
  - [ ] 2.16 Set proposal expiry (default: 72 hours from creation — configurable dev default, not architecture-specified)
  - [ ] 2.17 Execute Firestore transaction (**CRITICAL: All validation reads from Tasks 2.5-2.12 MUST use `transaction.get()` within this transaction to prevent TOCTOU race conditions — do NOT read documents outside the transaction and then write inside it**):
    - Read show, slot, and boxer documents via `transaction.get()` and re-validate status/existence
    - Create proposal document in `proposals` collection
    - Create deep-link token document in `deeplinkTokens` collection
    - Update slot status from `open` to `proposed`
    - Write audit log entry
  - [ ] 2.18 Generate deep-link URL: `https://{hosting-domain}/respond/{tokenId}`
  - [ ] 2.19 Generate shareable message text with bout details (boxer name, weight, show, date)
  - [ ] 2.20 Return CreateProposalResponse with deeplinkUrl and shareMessage
  - [ ] 2.21 Export function from `functions/src/index.ts`

- [ ] Task 3: Implement withdrawProposal Cloud Function (AC: 7, 8, 10)
  - [ ] 3.1 Create `functions/src/proposals/withdrawProposal.ts`
  - [ ] 3.2 Verify caller is authenticated
  - [ ] 3.3 Validate request fields (proposalId)
  - [ ] 3.4 Fetch proposal and verify it exists
  - [ ] 3.5 Verify proposal is in `proposed` status (only pending proposals can be withdrawn)
  - [ ] 3.6 Verify caller is a member of the proposal's fromClub
  - [ ] 3.7 Execute Firestore transaction:
    - Update proposal status to `withdrawn`
    - Update slot status from `proposed` to `open`
    - Update deep-link token status to `revoked`
    - Write audit log entry
  - [ ] 3.8 Return WithdrawProposalResponse
  - [ ] 3.9 Export function from `functions/src/index.ts`

- [ ] Task 4: Implement expireProposals scheduled function (AC: 9, 10)
  - [ ] 4.1 Create `functions/src/proposals/expireProposals.ts`
  - [ ] 4.2 Query all proposals where `status == 'proposed'` and `expiresAt <= now`
  - [ ] 4.3 For each expired proposal, execute batch:
    - Update proposal status to `expired`
    - Update slot status from `proposed` to `open`
    - Update deep-link token status to `expired`
    - Write audit log entry
  - [ ] 4.4 Handle batch size limits (process in batches of 500)
  - [ ] 4.5 Log count of expired proposals for monitoring
  - [ ] 4.6 Schedule function to run hourly via Cloud Scheduler
  - [ ] 4.7 Export function from `functions/src/index.ts`

- [ ] Task 5: Write unit tests for createProposal (AC: 1, 2, 3, 4, 5, 6, 10)
  - [ ] 5.1 Create `functions/src/__tests__/proposals/createProposal.test.ts`
  - [ ] 5.2 Test: Unauthenticated user rejected
  - [ ] 5.3 Test: User not a member of any club rejected
  - [ ] 5.4 Test: User not a member of the boxer's club rejected
  - [ ] 5.5 Test: Kill switch engaged returns unavailable error
  - [ ] 5.6 Test: Show does not exist rejected
  - [ ] 5.7 Test: Show not in published status rejected
  - [ ] 5.8 Test: Slot does not exist rejected
  - [ ] 5.9 Test: Slot not in open status rejected
  - [ ] 5.10 Test: Boxer does not exist rejected
  - [ ] 5.11 Test: Boxer not in active status rejected
  - [ ] 5.12 Test: Boxer belongs to different club than caller rejected
  - [ ] 5.13 Test: fromClub same as hostClub rejected (cannot propose to own show)
  - [ ] 5.14 Test: Show date in the past rejected
  - [ ] 5.15 Test: Boxer gender does not match slot targetGender rejected
  - [ ] 5.16 Test: Boxer category does not match slot category rejected
  - [ ] 5.17 Test: Successful proposal creation returns proposalId and deeplinkUrl
  - [ ] 5.18 Test: Proposal document created with correct data
  - [ ] 5.19 Test: Immutable boxer snapshot captured at creation time
  - [ ] 5.20 Test: Target boxer snapshot captured when slot has homeBoxer
  - [ ] 5.21 Test: Target boxer snapshot null when slot has no homeBoxer
  - [ ] 5.22 Test: Deep-link token created with correct properties (tokenId, proposalId, targetClubId, expiry)
  - [ ] 5.23 Test: Slot status atomically updated to proposed
  - [ ] 5.24 Test: Audit log entry written with proposal.created action
  - [ ] 5.25 Test: Proposal expiry set to 72 hours from creation
  - [ ] 5.26 Test: Share message includes boxer name, weight, show details

- [ ] Task 6: Write unit tests for withdrawProposal (AC: 7, 8, 10)
  - [ ] 6.1 Create `functions/src/__tests__/proposals/withdrawProposal.test.ts`
  - [ ] 6.2 Test: Unauthenticated user rejected
  - [ ] 6.3 Test: Proposal not found rejected
  - [ ] 6.4 Test: Proposal not in proposed status rejected
  - [ ] 6.5 Test: User not member of fromClub rejected
  - [ ] 6.6 Test: Successful withdrawal updates proposal status
  - [ ] 6.7 Test: Slot status reset to open on withdrawal
  - [ ] 6.8 Test: Deep-link token revoked on withdrawal
  - [ ] 6.9 Test: Audit log entry written with proposal.withdrawn action

- [ ] Task 7: Write unit tests for expireProposals (AC: 9, 10)
  - [ ] 7.1 Create `functions/src/__tests__/proposals/expireProposals.test.ts`
  - [ ] 7.2 Test: No expired proposals results in no changes
  - [ ] 7.3 Test: Single expired proposal processed correctly
  - [ ] 7.4 Test: Multiple expired proposals processed in batch
  - [ ] 7.5 Test: Already declined/withdrawn proposals not reprocessed
  - [ ] 7.6 Test: Slot status reset to open on expiry
  - [ ] 7.7 Test: Deep-link tokens marked expired
  - [ ] 7.8 Test: Audit log entry written for each expired proposal
  - [ ] 7.9 Test: Proposals not yet past expiresAt are not processed

## Dev Notes

### Previous Story Insights
[Source: Story 6.1 Dev Agent Record]
- 84 matchmaking tests added, 270 total tests passing
- Pattern established: Callable functions with auth + club membership validation
- `checkKillSwitch()` helper already exists in `functions/src/index.ts`
- `BoxerSearchResult` and `calculateAge` in `functions/src/types/discovery.ts` and `functions/src/discovery/searchBoxers.ts`
- Firebase Admin SDK mocking pattern well-established across all test files
- Anthropic SDK integration with graceful degradation pattern established

### Data Models

**Proposal Document** (`proposals/{proposalId}`)
[Source: Firebase implementation plan.md §1.4]
```
proposals/{proposalId}
├── proposalId: string
├── fromClubId: string
├── fromClubName: string              # Denormalized
├── toClubId: string
├── toClubName: string                # Denormalized
├── showId: string
├── slotId: string
├── showDate: timestamp               # Denormalized for filtering
├── proposedBoxerSnapshot: {          # IMMUTABLE at creation
│     boxerId: string
│     firstName: string
│     lastName: string
│     dob: timestamp
│     gender: string
│     category: string
│     declaredWeight: number
│     declaredBouts: number
│     declaredWins: number
│     declaredLosses: number
│     clubId: string
│     clubName: string
│     snapshotAt: timestamp
│   }
├── targetBoxerSnapshot: object | null  # If slot has homeBoxer
├── status: 'proposed' | 'accepted' | 'declined' | 'expired' | 'withdrawn' | 'voided'
├── statusReason: string | null
├── respondedAt: timestamp | null
├── respondedBy: string | null        # userId or 'deeplink'
├── deeplinkTokenId: string | null
├── expiresAt: timestamp
├── createdAt: timestamp
├── createdBy: string
└── updatedAt: timestamp
```
**Invariant:** Clients cannot write to status. Boxer snapshots are immutable.

**Deep-Link Token Document** (`deeplinkTokens/{tokenId}`)
[Source: Firebase implementation plan.md §1.6]
```
deeplinkTokens/{tokenId}
├── tokenId: string                   # Secure random
├── proposalId: string
├── targetClubId: string              # Club authorized to respond
├── action: 'respond'                 # Extensible for future actions
├── status: 'active' | 'consumed' | 'expired' | 'revoked'
├── consumedAt: timestamp | null
├── expiresAt: timestamp
├── createdAt: timestamp
└── createdBy: string
```
**Invariant:** Tokens are single-use, time-bound, club-bound. Resolved via Cloud Function only.

**Slot Model (relevant fields)**
[Source: Firebase implementation plan.md §1.3.1]
```
shows/{showId}/slots/{slotId}
├── status: 'open' | 'proposed' | 'secured' | 'closed'
├── homeBoxerId: string | null        # If host club is providing boxer
├── homeBoxerSnapshot: object | null
├── category: string
├── targetWeight: number
├── targetGender: 'male' | 'female'
```

**Show Model (relevant fields)**
[Source: Firebase implementation plan.md §1.3]
```
shows/{showId}
├── hostClubId: string
├── hostClubName: string
├── title: string
├── date: timestamp
├── status: 'draft' | 'published' | 'completed' | 'cancelled' | 'hidden'
```

### State Transition Rules
[Source: Firebase implementation plan.md §2.2]

**Slot Lifecycle (relevant to this story):**
```
open ──[createProposal]──► proposed
proposed ──[withdrawProposal]──► open
proposed ──[expireProposals]──► open
```

**Proposal Lifecycle (relevant to this story):**
```
(created via createProposal)
proposed ──[withdrawProposal]──► withdrawn
proposed ──[expireProposals]──► expired
```
Note: `accepted`, `declined`, and `voided` transitions are handled in Story 7.2 and admin stories.

### Cloud Function Ownership
[Source: Firebase implementation plan.md §2.1]

| Function | Trigger | Writes To |
|----------|---------|-----------|
| createProposal | HTTPS Callable | proposals, deeplinkTokens, slots, auditLogs |
| withdrawProposal | HTTPS Callable | proposals, slots, auditLogs |
| expireProposals | Scheduled (hourly) | proposals, slots, deeplinkTokens |

### Kill Switch Check
[Source: Firebase implementation plan.md §2.3]

`checkKillSwitch()` is required at the start of `createProposal`. This helper already exists in `functions/src/index.ts`. It reads `admin/settings` and throws `'unavailable'` if `proposalKillSwitch` is true.

### Security Rules (Already Deployed)
[Source: Firebase implementation plan.md §4.2]

- `proposals`: `allow write: if false` — Cloud Functions only
- `deeplinkTokens`: `allow read: if false; allow write: if false` — Cloud Functions only
- `proposals` read: Only by fromClub members, toClub members, or platform admin

### Deep-Link URL & Share Message
[Source: Architecture v1 §2.3, PRD §3.5]

- Deep links are shared via WhatsApp or SMS (link-based, no API integration)
- The system generates a URL and formatted message text
- The client copies/shares the message via native share or WhatsApp link
- URL format: `https://{hosting-domain}/respond/{tokenId}`
- Share message should include: boxer name, weight, show title, show date, link
- WhatsApp link format: `https://wa.me/?text={encodedMessage}`

### Architectural Constraints
[Source: Architecture v1 §12]

1. **Cloud Functions own state transitions** — Clients never directly mutate proposal, slot, or token state
2. **Derived data never stored** — Age computed from DOB + show date if needed
3. **Deep links are single-purpose** — Time-bound, club-bound, resolved only via Cloud Functions
4. **All admin actions are audited** — Audit logs are append-only and immutable
5. **Boxer snapshots are immutable** — Stored at proposal creation, never updated

### Audit Log Format
[Source: Firebase implementation plan.md §1.8]

```typescript
{
  action: 'proposal.created' | 'proposal.withdrawn' | 'proposal.expired',
  actorId: string,        // userId or 'system' for scheduled
  actorType: 'user' | 'system',
  targetType: 'proposal',
  targetId: string,       // proposalId
  targetClubId: string,   // fromClubId for create/withdraw, null for expire
  details: {
    proposalId: string,
    fromClubId: string,
    toClubId: string,
    showId: string,
    slotId: string,
    boxerId: string,
    // additional context
  },
  timestamp: FieldValue.serverTimestamp(),
  ipAddress: null
}
```

### File Structure
```
functions/src/
├── proposals/                    # NEW - Story 7.1
│   ├── createProposal.ts        # Main callable function
│   ├── withdrawProposal.ts      # Withdraw callable function
│   └── expireProposals.ts       # Scheduled cleanup function
├── types/
│   ├── proposal.ts              # NEW - Proposal types
│   └── deeplinkToken.ts         # NEW - Deep-link token types
├── __tests__/
│   └── proposals/               # NEW - Test folder
│       ├── createProposal.test.ts
│       ├── withdrawProposal.test.ts
│       └── expireProposals.test.ts
└── index.ts                     # Export new functions
```

### Existing Types & Functions to Reuse
[Source: functions/src/types/boxer.ts, functions/src/types/club.ts]

```typescript
// Boxer fields for snapshot (from boxer.ts)
interface Boxer {
  boxerId: string;
  firstName: string;
  lastName: string;
  dob: Timestamp;
  gender: 'male' | 'female';
  category: string;
  declaredWeight: number;
  declaredBouts: number;
  declaredWins: number;
  declaredLosses: number;
  dataStatus: 'draft' | 'active' | 'archived';
  availability: 'available' | 'unavailable' | 'injured';
  // ... other fields
}

// Club fields for denormalization (from club.ts)
interface Club {
  name: string;
  status: 'unclaimed' | 'claim_pending' | 'claimed' | 'suspended';
  // ... other fields
}
```

### Dependency Note
This story assumes shows and slots can exist in Firestore (either seeded for testing or created via client writes per security rules). Story 8.x (Show Management) handles the show/slot creation UI and Cloud Functions, but the raw Firestore documents may already exist. For testing, mock show and slot documents directly.

## Testing

### Test File Locations
- `functions/src/__tests__/proposals/createProposal.test.ts`
- `functions/src/__tests__/proposals/withdrawProposal.test.ts`
- `functions/src/__tests__/proposals/expireProposals.test.ts`

### Testing Patterns
[Source: Existing test patterns from Stories 4.x, 5.1, 6.1]
- Mock Firebase Admin SDK (Firestore, Auth) — follow established patterns
- Mock `admin.firestore()` for document reads, writes, and transactions
- Test authentication and authorization checks separately
- Test each validation rule in isolation
- Test transaction atomicity (all writes succeed or all fail)
- Follow established mocking patterns from previous stories
- Use `firebase-functions-test` for callable function testing

### Coverage Requirements
- All 10 acceptance criteria must have corresponding tests
- Each validation check must be individually tested
- Transaction atomicity must be verified
- Edge cases: duplicate proposals for same slot, concurrent withdrawals, expired proposals
- Minimum: 41 test cases across all test files (25 createProposal + 8 withdrawProposal + 8 expireProposals)

---

## Change Log
| Date | Author | Change |
|------|--------|--------|
| 2026-01-29 | Bob (SM) | Applied QA REC-001: Added explicit transaction.get() guidance to Task 2.17 to prevent TOCTOU race conditions on slot status |
| 2026-01-29 | Quinn (QA) | Pre-implementation QA review: PASS (90/100). REC-001 flagged for transaction read clarification. Gate file created. |
| 2026-01-29 | Sarah (PO) | PO Validation: Added show date future check (Task 2.10, Test 5.14), slot requirement matching for gender/category (Tasks 2.11-2.12, Tests 5.15-5.16), fixed test count arithmetic (41 tests). Assessment: GO. |
| 2026-01-29 | Bob (SM) | Initial draft |

---

## Dev Agent Record

### Agent Model Used
*To be populated during implementation*

### Debug Log References
*To be populated during implementation*

### Completion Notes
*To be populated during implementation*

### File List
*To be populated during implementation*

---

## QA Results

### Pre-Implementation Review Date: 2026-01-29

### Reviewed By: Quinn (Test Architect)

### Review Type: Pre-Implementation Quality Gate

This is a design-time review of the story before implementation begins.

---

### Requirements Traceability Assessment

| AC | Mapped Tasks | Test Coverage | Given-When-Then | Status |
|----|-------------|---------------|-----------------|--------|
| AC1 | Tasks 2.2-2.12 | 5.2-5.17 | Given authenticated member with active boxer, When creating proposal for published show's open slot, Then proposal created | COVERED |
| AC2 | Task 2.13 | 5.19-5.21 | Given valid proposal creation, When proposal created, Then proposedBoxerSnapshot captured with snapshotAt | COVERED |
| AC3 | Task 2.15 | 5.22 | Given valid proposal creation, When token generated, Then token is club-bound, time-bound, single-use | COVERED |
| AC4 | Tasks 2.18-2.19 | 5.26 | Given successful proposal, When response returned, Then includes deep-link URL and shareable message | COVERED |
| AC5 | Task 2.17 | 5.23 | Given successful proposal, When transaction completes, Then slot status atomically updated to 'proposed' | COVERED |
| AC6 | Task 2.3 | 5.5 | Given proposalKillSwitch enabled, When creating proposal, Then rejected with 'unavailable' | COVERED |
| AC7 | Tasks 3.2-3.6 | 6.2-6.6 | Given proposal in 'proposed' by user's club, When withdrawing, Then status → 'withdrawn' | COVERED |
| AC8 | Task 3.7 | 6.7-6.8 | Given withdrawal, When transaction completes, Then slot → 'open' and token revoked | COVERED |
| AC9 | Tasks 4.2-4.6 | 7.2-7.9 | Given proposals past expiresAt, When scheduled function runs, Then marked expired, slots reset | COVERED |
| AC10 | Tasks 2.17, 3.7, 4.3 | 5.24, 6.9, 7.8 | Given any proposal state transition, When transition completes, Then audit log written | COVERED |

**Traceability Score: 10/10 ACs fully mapped**

---

### Test Design Adequacy

| Test File | Planned Tests | Coverage Areas |
|-----------|---------------|----------------|
| createProposal.test.ts | 25 | Auth, validation (12 checks), happy path, snapshots, token, slot update, audit, share message |
| withdrawProposal.test.ts | 8 | Auth, validation, happy path, slot reset, token revoke, audit |
| expireProposals.test.ts | 8 | No-op, single, batch, idempotency, slot reset, token expire, audit, timing |
| **Total** | **41** | All ACs covered |

**Recommendations implemented by PO:**
- [x] Show date future validation (Task 2.10, Test 5.14)
- [x] Gender/category slot matching (Tasks 2.11-2.12, Tests 5.15-5.16)
- [x] Test count arithmetic corrected

**Additional test recommendations:**
- [ ] Add test: Concurrent proposal creation for same slot (transaction conflict handled gracefully) — Task 5, new test
- [ ] Add test: Firestore transaction rollback on partial failure — Task 5, new test

---

### Risk Assessment

| Risk Area | Probability | Impact | Score | Mitigation |
|-----------|-------------|--------|-------|------------|
| Transaction TOCTOU on slot status | Medium | High | 6 | Slot read MUST be inside transaction (see recommendation below) |
| Concurrent slot proposals | Medium | Low | 3 | Transaction conflict detection rejects second proposal |
| Token predictability | Low | High | 3 | crypto.randomUUID provides 122-bit randomness |
| Kill switch bypass | Low | Critical | 3 | Checked at function entry, not bypassable by client |
| Proposal to past show | Low | Medium | 2 | Validated (Task 2.10) |
| Gender/category mismatch | Low | Low | 1 | Validated (Tasks 2.11-2.12) |

**Highest Risk:** Transaction TOCTOU (score 6) — see critical recommendation REC-001 below.

---

### NFR Validation

| NFR | Status | Notes |
|-----|--------|-------|
| **Security** | PASS | Auth + club membership validated; kill switch; tokens time-bound/club-bound; Firestore rules prevent client writes; `sanitizeInput` pattern available from Story 6.1 |
| **Performance** | PASS | No LLM calls; single Firestore transaction; scheduled function batches in 500s |
| **Reliability** | PASS | Atomic transactions; scheduled cleanup; clear error messages |
| **Maintainability** | PASS | Clean module separation (`proposals/`, `types/`); follows established patterns; 41 tests planned |

---

### Compliance Check

- Coding Standards: N/A (pre-implementation)
- Project Structure: PASS — New files follow established conventions (`proposals/`, `types/`, `__tests__/proposals/`)
- Testing Strategy: PASS — Unit tests with Firebase Admin SDK mocking, follows Stories 4.x-6.1 patterns
- All ACs Met: PASS — 10/10 ACs mapped to tasks and tests
- Architecture Alignment: PASS — Data models match Firebase implementation plan exactly

---

### Security Review

**No security concerns found.** The story correctly:
- Requires authentication for all callable functions
- Validates club membership authorization
- Integrates the kill switch check
- Uses secure random tokens (crypto.randomUUID)
- Enforces time-bound, club-bound, single-use token constraints
- Prevents client writes via Firestore rules (write: if false)
- Prevents proposing to own show (Task 2.9)

---

### Recommendations

**REC-001 (Immediate — clarify before implementation):**
Task 2.17 specifies a Firestore transaction for writes, but Tasks 2.5-2.12 list validation reads without explicitly stating they must occur within the transaction. The slot status read (Task 2.7) MUST use `transaction.get()` inside the transaction — otherwise a concurrent proposal could race past the slot status check and create duplicate proposals for the same slot (TOCTOU vulnerability).

**Suggested clarification:** Add a note to Task 2.17 stating: "All document reads for validation (show, slot, boxer) MUST use `transaction.get()` within this transaction to prevent race conditions."

**REC-002 (Future — post-MVP):**
Consider adding a boxer availability warning. Currently, an `injured` or `unavailable` boxer can be proposed. This is arguably correct (clubs manage availability and may update it before show date), but a non-blocking warning in the response could help clubs catch mistakes.

**REC-003 (Future — post-MVP):**
The withdrawProposal function also writes to `deeplinkTokens` (revoke token) per Task 3.7, but the Cloud Function ownership table in the Firebase plan lists withdrawProposal as writing to "proposals, slots, auditLogs" only. The story's approach is correct — flag this discrepancy for architecture doc cleanup.

---

### Gate Status

**Gate: PASS**

Gate file: `docs/qa/gates/7.1-send-bout-proposal.yml`

**Rationale:** Story is well-structured with comprehensive traceability (10/10 ACs), adequate test coverage (41 planned tests), strong security model, and correct architecture alignment. REC-001 (transaction read clarification) is a valid implementation concern but does not block the story — a competent developer using Firestore transactions will naturally include reads within the transaction. Flagged as a recommendation for explicit guidance.

---

### Recommended Status

PASS — **Ready for Implementation**

REC-001 should be communicated to the dev agent (include transaction read guidance). Story owner may proceed.
