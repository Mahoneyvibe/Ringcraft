# Story 3.2: View Club Members

## Status
Draft

## Story
**As a** club member,
**I want** to see who represents my club,
**So that** I know who is acting on our behalf.

## Acceptance Criteria
1. Member list shows name, role, and profile photo
2. Any authenticated user can view club members (read-only for directory browsing)

## Tasks / Subtasks

- [ ] Task 1: Create getClubMembers callable function (AC: 1, 2)
  - [ ] 1.1 Create `functions/src/clubs/getClubMembers.ts`
  - [ ] 1.2 Validate user is authenticated
  - [ ] 1.3 Query `clubs/{clubId}/members` subcollection
  - [ ] 1.4 Return member list: userId, displayName, photoURL, role, joinedAt
  - [ ] 1.5 Export function from `functions/src/index.ts`

- [ ] Task 2: Add photoURL field to ClubMember interface (AC: 1)
  - [ ] 2.1 Add `photoURL?: string` to `ClubMember` interface in `functions/src/types/club.ts`
  - [ ] 2.2 Update `approveClubClaim` to include photoURL when creating member document

- [ ] Task 3: Create TypeScript interfaces for request/response (AC: 1)
  - [ ] 3.1 Add `GetClubMembersRequest` interface to `functions/src/types/club.ts`
  - [ ] 3.2 Add `GetClubMembersResponse` interface to `functions/src/types/club.ts`
  - [ ] 3.3 Add `ClubMemberListItem` interface (public-facing member data)

- [ ] Task 4: Write unit tests for getClubMembers (AC: 1, 2)
  - [ ] 4.1 Test: Unauthenticated user cannot get members
  - [ ] 4.2 Test: Any authenticated user CAN get any club's members
  - [ ] 4.3 Test: Returns correct member data (displayName, photoURL, role, joinedAt)
  - [ ] 4.4 Test: Empty club returns empty array
  - [ ] 4.5 Test: Non-existent club returns appropriate error

## Dev Notes

### Previous Story Insights
[Source: Story 2.2 Dev Notes]
- ClubMember interface already exists in `functions/src/types/club.ts`
- Member document is created in `approveClubClaim` function
- Existing pattern: callable functions with auth check, proper error codes
- User's clubMemberships array is updated when joining a club

### Data Models
[Source: Firebase implementation plan.md §1.2.1]

```typescript
// clubs/{clubId}/members/{userId}
interface ClubMember {
  userId: string;
  displayName: string;            // Denormalized from user
  photoURL?: string;              // Profile photo URL (to be added)
  role: ClubMemberRole;           // 'coach' | 'matchmaker' | 'secretary' | 'chair'
  joinedAt: Timestamp;
  updatedAt: Timestamp;
}
```

**Note:** Role is descriptive only at MVP — not enforced in security rules.
**Note:** `photoURL` field needs to be added to the ClubMember interface per AC 1.

### Security Rules - No Changes Required
[Source: firestore.rules lines 47-51]

**Current rule (CORRECT):**
```
match /members/{memberId} {
  allow read: if isAuthenticated();
  allow write: if false;  // Cloud Functions only
}
```

**Design rationale:** Any authenticated user can view any club's members for directory browsing purposes. This matches the boxer browsing pattern where authenticated users can view other clubs' boxers for matchmaking. The callable function simply requires authentication - no club membership check needed.

### File Locations
[Source: Project structure]
- New function: `functions/src/clubs/getClubMembers.ts`
- Types update: `functions/src/types/club.ts`
- Tests: `functions/src/__tests__/clubs/getClubMembers.test.ts`
- Existing function update: `functions/src/clubs/claimClub.ts` (add photoURL to member creation)

### Testing Requirements
[Source: Existing test patterns]
- Use Firebase emulator suite for testing
- Test callable function authorization and response
- Cover positive and negative cases
- Use established test patterns from `searchClubs.test.ts` and `claimClub.test.ts`

### Technical Constraints
- Callable function pattern (not HTTP)
- No direct Firestore reads by client - use Cloud Function
- Return only necessary fields (no sensitive data)

## Testing
- [ ] All unit tests pass
- [ ] Manual verification: authenticated user can view any club's members
- [ ] Manual verification: unauthenticated user cannot access member list

## Dev Agent Record
<!-- Populated by dev agent during implementation -->

### Implementation Notes
_To be filled during development_

### Deviations
_To be filled if implementation differs from plan_

### Completion Notes
_To be filled on completion_

## QA Results

### Review Date: 2026-01-06

### Reviewed By: Quinn (Test Architect)

### Review Type: Pre-Implementation

### Assessment

Story is well-defined and ready for development:

- **Requirements**: ACs are clear and testable
- **Technical Feasibility**: User doc already has `photoURL` field (onUserCreate.ts line 22)
- **Security Model**: Current rules correct - callable function enforces club membership
- **Patterns**: Established in searchClubs, claimClub, approveClubClaim

### Clarifications

- **Task 2.2**: `photoURL` will be fetched from user document's existing `photoURL` field (same pattern as `displayName` in approveClubClaim line 128)

### AC Validation

| AC | Description | How Validated | Status |
|----|-------------|---------------|--------|
| 1 | Member list shows name, role, profile photo | Task 1.4 returns fields; Task 2 adds photoURL to schema | Ready |
| 2 | Any authenticated user can view members | Task 1.2 validates authentication only | Ready |

### Future Consideration

- Consider photoURL sync mechanism if users update profile photos after joining (low priority)

### Gate Status

**Gate: PASS** - docs/qa/gates/3.2-view-club-members.yml

### Recommended Status

[Ready for Implementation]

## Change Log
| Date | Author | Change |
|------|--------|--------|
| 2026-01-06 | Quinn (QA) | Corrected AC 2: any authenticated user can view (aligned with security model) |
| 2026-01-06 | Quinn (QA) | Pre-implementation review: PASS |
| 2026-01-06 | Bob (SM) | Revised: Added photoURL field task, removed security rules task per PO clarification |
| 2026-01-06 | Bob (SM) | Initial draft |
