# Story 3.2: View Club Members

## Status
Done

## Story
**As a** club member,
**I want** to see who represents my club,
**So that** I know who is acting on our behalf.

## Acceptance Criteria
1. Member list shows name, role, and profile photo
2. Any authenticated user can view club members (read-only for directory browsing)

## Tasks / Subtasks

- [x] Task 1: Create getClubMembers callable function (AC: 1, 2)
  - [x] 1.1 Create `functions/src/clubs/getClubMembers.ts`
  - [x] 1.2 Validate user is authenticated
  - [x] 1.3 Query `clubs/{clubId}/members` subcollection
  - [x] 1.4 Return member list: userId, displayName, photoURL, role, joinedAt
  - [x] 1.5 Export function from `functions/src/index.ts`

- [x] Task 2: Add photoURL field to ClubMember interface (AC: 1)
  - [x] 2.1 Add `photoURL?: string` to `ClubMember` interface in `functions/src/types/club.ts`
  - [x] 2.2 Update `approveClubClaim` to include photoURL when creating member document

- [x] Task 3: Create TypeScript interfaces for request/response (AC: 1)
  - [x] 3.1 Add `GetClubMembersRequest` interface to `functions/src/types/club.ts`
  - [x] 3.2 Add `GetClubMembersResponse` interface to `functions/src/types/club.ts`
  - [x] 3.3 Add `ClubMemberListItem` interface (public-facing member data)

- [x] Task 4: Write unit tests for getClubMembers (AC: 1, 2)
  - [x] 4.1 Test: Unauthenticated user cannot get members
  - [x] 4.2 Test: Any authenticated user CAN get any club's members
  - [x] 4.3 Test: Returns correct member data (displayName, photoURL, role, joinedAt)
  - [x] 4.4 Test: Empty club returns empty array
  - [x] 4.5 Test: Non-existent club returns appropriate error

## Dev Notes

### Previous Story Insights
[Source: Story 2.2 Dev Notes]
- ClubMember interface already exists in `functions/src/types/club.ts`
- Member document is created in `approveClubClaim` function
- Existing pattern: callable functions with auth check, proper error codes
- User's clubMemberships array is updated when joining a club

### Data Models
[Source: Firebase implementation plan.md §1.2.1]

```typescript
// clubs/{clubId}/members/{userId}
interface ClubMember {
  userId: string;
  displayName: string;            // Denormalized from user
  photoURL?: string;              // Profile photo URL (to be added)
  role: ClubMemberRole;           // 'coach' | 'matchmaker' | 'secretary' | 'chair'
  joinedAt: Timestamp;
  updatedAt: Timestamp;
}
```

**Note:** Role is descriptive only at MVP — not enforced in security rules.
**Note:** `photoURL` field needs to be added to the ClubMember interface per AC 1.

### Security Rules - No Changes Required
[Source: firestore.rules lines 47-51]

**Current rule (CORRECT):**
```
match /members/{memberId} {
  allow read: if isAuthenticated();
  allow write: if false;  // Cloud Functions only
}
```

**Design rationale:** Any authenticated user can view any club's members for directory browsing purposes. This matches the boxer browsing pattern where authenticated users can view other clubs' boxers for matchmaking. The callable function simply requires authentication - no club membership check needed.

### File Locations
[Source: Project structure]
- New function: `functions/src/clubs/getClubMembers.ts`
- Types update: `functions/src/types/club.ts`
- Tests: `functions/src/__tests__/clubs/getClubMembers.test.ts`
- Existing function update: `functions/src/clubs/claimClub.ts` (add photoURL to member creation)

### Testing Requirements
[Source: Existing test patterns]
- Use Firebase emulator suite for testing
- Test callable function authorization and response
- Cover positive and negative cases
- Use established test patterns from `searchClubs.test.ts` and `claimClub.test.ts`

### Technical Constraints
- Callable function pattern (not HTTP)
- No direct Firestore reads by client - use Cloud Function
- Return only necessary fields (no sensitive data)

## Testing
- [x] All unit tests pass (90/90)
- [ ] Manual verification: authenticated user can view any club's members
- [ ] Manual verification: unauthenticated user cannot access member list

## File List
- `functions/src/clubs/getClubMembers.ts` (new)
- `functions/src/types/club.ts` (modified - added photoURL, interfaces)
- `functions/src/clubs/approveClubClaim.ts` (modified - added photoURL to member creation)
- `functions/src/index.ts` (modified - export getClubMembers)
- `functions/src/__tests__/clubs/getClubMembers.test.ts` (new)

## Dev Agent Record
<!-- Populated by dev agent during implementation -->

### Agent Model Used
Claude Opus 4.5

### Implementation Notes
- Followed existing callable function pattern from searchClubs.ts
- Added photoURL field to ClubMember interface (string | null)
- Created ClubMemberListItem to exclude updatedAt from public response
- getClubMembers validates authentication but NOT club membership (per AC 2)
- Function verifies club exists before querying members
- All 90 tests pass including 11 new tests for getClubMembers

### Deviations
None - implementation matches story plan exactly.

### Completion Notes
- All 4 tasks completed with all subtasks
- Lint passes with no errors
- All unit tests pass (90/90)
- photoURL now included in member creation (approveClubClaim updated)

## QA Results

### Pre-Implementation Review: 2026-01-06

**Reviewed By:** Quinn (Test Architect)
**Gate:** PASS - Ready for implementation

---

### Post-Implementation Review: 2026-01-06

**Reviewed By:** Quinn (Test Architect)

### Code Quality Assessment

| Area | Status |
|------|--------|
| Pattern Adherence | PASS - Follows searchClubs pattern |
| TypeScript Typing | PASS - Proper interfaces |
| Authentication | PASS - Correct HttpsError codes |
| Input Validation | PASS - Handles edge cases |
| Error Handling | PASS - Proper error codes |
| Data Transformation | PASS - Excludes updatedAt |

### Requirements Traceability

| AC | Tests | Status |
|----|-------|--------|
| 1 - name, role, photo | 3 tests in "Member data (AC: 1)" | PASS |
| 2 - any authenticated user | 3 tests in "Authentication" + "Cross-club access" | PASS |

### Test Coverage

- 11 new tests added
- All 90 project tests pass
- Edge cases covered: empty clubId, non-existent club, null photoURL, empty member list

### Security Review

- Authentication enforced
- No sensitive data exposed (updatedAt excluded)
- Input validated and sanitized

### NFR Validation

| Attribute | Status |
|-----------|--------|
| Security | PASS |
| Performance | PASS |
| Reliability | PASS |
| Maintainability | PASS |

### Minor Observations (Non-Blocking)

1. No pagination - acceptable for MVP (clubs have few members)
2. No sorting - uses Firestore default order

### Gate Status

**Gate: PASS** - docs/qa/gates/3.2-view-club-members.yml

### Recommended Status

[Ready for Done]

## Change Log
| Date | Author | Change |
|------|--------|--------|
| 2026-01-06 | Bob (SM) | Story marked Done after QA PASS gate |
| 2026-01-06 | James (Dev) | Implementation complete - all tasks done, 90 tests pass |
| 2026-01-06 | Quinn (QA) | Corrected AC 2: any authenticated user can view (aligned with security model) |
| 2026-01-06 | Quinn (QA) | Pre-implementation review: PASS |
| 2026-01-06 | Bob (SM) | Revised: Added photoURL field task, removed security rules task per PO clarification |
| 2026-01-06 | Bob (SM) | Initial draft |
